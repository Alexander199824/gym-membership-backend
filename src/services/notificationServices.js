// src/services/notificationServices.js - CORREGIDO: Gmail con nodemailer
const nodemailer = require('nodemailer');
const twilio = require('twilio');

class EmailService {
  constructor() {
    // Verificar que las credenciales de Gmail sean v√°lidas
    const hasValidGmailConfig = 
      process.env.GMAIL_USER &&
      process.env.GMAIL_APP_PASSWORD &&
      process.env.GMAIL_USER !== 'yourEmail@email.com' && // No es placeholder
      process.env.GMAIL_APP_PASSWORD !== 'yourPassword' && // No es placeholder
      process.env.GMAIL_APP_PASSWORD.length > 10; // Validaci√≥n b√°sica de longitud

    if (hasValidGmailConfig) {
      try {
        // ‚úÖ CORREGIDO: createTransport (no createTransporter)
        this.transporter = nodemailer.createTransport({
          host: "smtp.gmail.com",
          port: 465,
          secure: true, // true para 465, false para otros puertos
          auth: {
            user: process.env.GMAIL_USER,
            pass: process.env.GMAIL_APP_PASSWORD
          },
          // Configuraciones adicionales para Gmail
          pool: true, // Pool de conexiones para mejor performance
          maxConnections: 5,
          maxMessages: 10,
          rateDelta: 1000, // 1 segundo entre emails
          rateLimit: 5 // m√°ximo 5 emails por segundo
        });
        
        this.isConfigured = true;
        console.log('‚úÖ Gmail Email Service inicializado correctamente');
        console.log(`   üìß Usuario configurado: ${process.env.GMAIL_USER}`);
        
        // Verificar configuraci√≥n sin enviar email de prueba
        this.verifyConfiguration(false); // false = no enviar email de prueba
      } catch (error) {
        console.error('‚ùå Error al inicializar Gmail:', error.message);
        this.transporter = null;
        this.isConfigured = false;
      }
    } else {
      console.warn('‚ö†Ô∏è Gmail no configurado correctamente - Las notificaciones por email no funcionar√°n');
      
      // Diagn√≥stico detallado
      if (!process.env.GMAIL_USER) {
        console.warn('   ‚ùå GMAIL_USER no configurado');
      } else if (process.env.GMAIL_USER === 'yourEmail@email.com') {
        console.warn('   ‚ùå GMAIL_USER todav√≠a tiene el valor placeholder');
      }
      
      if (!process.env.GMAIL_APP_PASSWORD) {
        console.warn('   ‚ùå GMAIL_APP_PASSWORD no configurado');
      } else if (process.env.GMAIL_APP_PASSWORD === 'yourPassword') {
        console.warn('   ‚ùå GMAIL_APP_PASSWORD todav√≠a tiene el valor placeholder');
      } else if (process.env.GMAIL_APP_PASSWORD.length <= 10) {
        console.warn('   ‚ùå GMAIL_APP_PASSWORD parece ser demasiado corto (no es una App Password)');
      }
      
      console.warn('   üí° Configura GMAIL_USER y GMAIL_APP_PASSWORD correctamente');
      this.transporter = null;
      this.isConfigured = false;
    }
  }

  // ‚úÖ MEJORADO: Verificar configuraci√≥n de Gmail con control de email de prueba
  async verifyConfiguration(sendTestEmail = false) {
    try {
      if (!this.transporter) {
        console.warn('‚ö†Ô∏è No hay transporter de Gmail para verificar');
        return false;
      }

      console.log('üîç Verificando configuraci√≥n de Gmail...');
      
      // Verificar que la conexi√≥n funcione
      const isVerified = await this.transporter.verify();
      
      if (isVerified) {
        console.log('‚úÖ Configuraci√≥n de Gmail verificada exitosamente');
        console.log('   üìß SMTP Gmail conectado correctamente');
        
        // ‚úÖ CORREGIDO: Solo enviar email de prueba si se solicita expl√≠citamente
        if (sendTestEmail) {
          await this.sendTestEmail();
        }
        
        return true;
      } else {
        console.warn('‚ö†Ô∏è Error al verificar configuraci√≥n de Gmail');
        this.isConfigured = false;
        return false;
      }
    } catch (error) {
      console.error('‚ùå Error al verificar configuraci√≥n de Gmail:', error.message);
      
      // Diagn√≥stico espec√≠fico del error
      if (error.code === 'EAUTH') {
        console.error('   üö® Error de autenticaci√≥n:');
        console.error('      - Verifica que GMAIL_USER sea correcto');
        console.error('      - Verifica que GMAIL_APP_PASSWORD sea una App Password v√°lida');
        console.error('      - Aseg√∫rate de que 2FA est√© habilitado en Gmail');
      } else if (error.code === 'ECONNECTION') {
        console.error('   üö® Error de conexi√≥n con Gmail SMTP');
      } else if (error.code === 'ETIMEDOUT') {
        console.error('   üö® Timeout conectando con Gmail');
      }
      
      this.isConfigured = false;
      return false;
    }
  }

  // ‚úÖ NUEVO: Enviar email de prueba para verificar funcionamiento
  async sendTestEmail() {
    try {
      if (!this.isConfigured || !this.transporter) {
        return { success: false, message: 'Gmail no configurado' };
      }

      const testEmail = {
        from: {
          name: process.env.GMAIL_SENDER_NAME || 'Elite Fitness Club',
          address: process.env.GMAIL_USER
        },
        to: process.env.GMAIL_USER, // Enviarse a s√≠ mismo
        subject: '‚úÖ Test de configuraci√≥n Gmail - Elite Fitness Club',
        html: `
          <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
            <h2 style="color: #2c3e50;">‚úÖ Gmail configurado correctamente</h2>
            <p>Este es un email de prueba para verificar que la configuraci√≥n de Gmail est√° funcionando correctamente.</p>
            <div style="background-color: #f8f9fa; padding: 15px; border-radius: 5px; margin: 15px 0;">
              <h3>üìã Informaci√≥n de configuraci√≥n:</h3>
              <ul>
                <li><strong>Usuario:</strong> ${process.env.GMAIL_USER}</li>
                <li><strong>Servidor:</strong> smtp.gmail.com:465</li>
                <li><strong>Fecha:</strong> ${new Date().toLocaleString('es-ES')}</li>
                <li><strong>Sistema:</strong> Elite Fitness Club Management</li>
              </ul>
            </div>
            <p>Si recibes este email, ¬°las notificaciones funcionar√°n correctamente! üéâ</p>
          </div>
        `,
        text: `‚úÖ Gmail configurado correctamente para Elite Fitness Club. Email de prueba enviado el ${new Date().toLocaleString('es-ES')}`
      };

      const result = await this.transporter.sendMail(testEmail);
      console.log('‚úÖ Email de prueba enviado exitosamente:', result.messageId);
      console.log('   üì¨ Revisa la bandeja de entrada de', process.env.GMAIL_USER);
      
      return { success: true, messageId: result.messageId };
    } catch (error) {
      console.error('‚ùå Error al enviar email de prueba:', error.message);
      return { success: false, error: error.message };
    }
  }

  async sendEmail({ to, subject, html, text, attachments = null }) {
    try {
      if (!process.env.NOTIFICATION_EMAIL_ENABLED || process.env.NOTIFICATION_EMAIL_ENABLED !== 'true') {
        console.log('üìß Email deshabilitado en configuraci√≥n (NOTIFICATION_EMAIL_ENABLED=false)');
        return { success: false, message: 'Email deshabilitado en configuraci√≥n' };
      }

      if (!this.isConfigured || !this.transporter) {
        console.warn('üìß Gmail no configurado correctamente - no se puede enviar email');
        return { success: false, message: 'Gmail no configurado correctamente' };
      }

      // Preparar el email
      const mailOptions = {
        from: {
          name: process.env.GMAIL_SENDER_NAME || 'Elite Fitness Club',
          address: process.env.GMAIL_USER
        },
        to: to,
        subject: subject,
        text: text || undefined,
        html: html || undefined,
        attachments: attachments || undefined
      };

      console.log(`üì§ Enviando email a: ${to}`);
      console.log(`üìÑ Asunto: ${subject}`);

      // Enviar email a trav√©s de Gmail
      const result = await this.transporter.sendMail(mailOptions);
      
      console.log('‚úÖ Email enviado exitosamente v√≠a Gmail:', result.messageId);
      console.log(`   üìß A: ${to}`);
      console.log(`   üìÑ Asunto: ${subject}`);
      
      return { 
        success: true, 
        messageId: result.messageId,
        provider: 'gmail',
        response: result.response,
        to: to,
        subject: subject
      };
    } catch (error) {
      console.error('‚ùå Error al enviar email v√≠a Gmail:', error);
      
      // Manejar errores espec√≠ficos de Gmail/SMTP
      let errorMessage = error.message;
      let errorCode = error.code;
      
      if (error.code === 'EAUTH') {
        errorMessage = 'Error de autenticaci√≥n con Gmail. Verifica las credenciales.';
        console.error('   üîë Verifica GMAIL_USER y GMAIL_APP_PASSWORD');
      } else if (error.code === 'ECONNECTION') {
        errorMessage = 'Error de conexi√≥n con el servidor de Gmail.';
        console.error('   üåê Problema de conectividad con smtp.gmail.com');
      } else if (error.responseCode === 550) {
        errorMessage = 'Email rechazado por el destinatario.';
        console.error('   üì≠ El email fue rechazado:', to);
      } else if (error.code === 'EMESSAGE') {
        errorMessage = 'Error en el contenido del mensaje.';
        console.error('   üìù Revisa el contenido del email');
      }
      
      return { 
        success: false, 
        error: errorMessage,
        errorCode: errorCode,
        provider: 'gmail',
        to: to,
        subject: subject
      };
    }
  }

  // Templates de email optimizados para Gmail (MANTIENEN EL DISE√ëO ORIGINAL)
  generateWelcomeEmail(user) {
    const html = `
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>¬°Bienvenido al Gimnasio!</title>
        <style>
          body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f4f4; }
          .container { max-width: 600px; margin: 0 auto; background-color: #ffffff; }
          .header { background-color: #2c3e50; color: #ffffff; padding: 20px; text-align: center; }
          .content { padding: 30px; }
          .button { display: inline-block; background-color: #3498db; color: #ffffff; padding: 12px 25px; text-decoration: none; border-radius: 5px; margin: 20px 0; }
          .footer { background-color: #ecf0f1; padding: 20px; text-align: center; font-size: 12px; color: #7f8c8d; }
          .highlight { background-color: #f8f9fa; padding: 15px; border-radius: 5px; margin: 15px 0; }
        </style>
      </head>
      <body>
        <div class="container">
          <div class="header">
            <h1>üèãÔ∏è‚Äç‚ôÇÔ∏è ¬°Bienvenido a Elite Fitness Club!</h1>
          </div>
          <div class="content">
            <h2>¬°Hola ${user.getFullName()}!</h2>
            <p>¬°Bienvenido a nuestra familia fitness! Estamos emocionados de tenerte con nosotros en este incre√≠ble viaje hacia una vida m√°s saludable.</p>
            
            <div class="highlight">
              <h3>‚úÖ Tu cuenta ha sido creada exitosamente</h3>
              <p>Ahora puedes disfrutar de todos nuestros servicios:</p>
              <ul>
                <li>üìä Ver el estado de tu membres√≠a en tiempo real</li>
                <li>üìÖ Programar y gestionar tus horarios de entrenamiento</li>
                <li>üîî Recibir recordatorios autom√°ticos de vencimiento</li>
                <li>üõçÔ∏è Acceder a nuestra tienda de productos fitness</li>
                <li>üí∞ Gestionar tus pagos de forma segura</li>
              </ul>
            </div>

            <p style="text-align: center;">
              <a href="${process.env.FRONTEND_URL || '#'}" class="button">Acceder a Mi Cuenta</a>
            </p>
            
            <p>Si tienes alguna pregunta, no dudes en contactarnos. ¬°Estamos aqu√≠ para ayudarte a alcanzar tus objetivos!</p>
            
            <p style="margin-top: 30px;"><strong>¬°Nos vemos en el gym! üí™</strong></p>
          </div>
          <div class="footer">
            <p>Este es un mensaje autom√°tico de Elite Fitness Club</p>
            <p>üìß Email: ${process.env.GMAIL_USER} | üìû Tel: ${process.env.GYM_PHONE || 'Contacta recepci√≥n'}</p>
          </div>
        </div>
      </body>
      </html>
    `;
    
    return {
      subject: 'üèãÔ∏è‚Äç‚ôÇÔ∏è ¬°Bienvenido a Elite Fitness Club!',
      html,
      text: `¬°Bienvenido ${user.getFullName()}! Tu cuenta en Elite Fitness Club ha sido creada exitosamente. ¬°Nos vemos en el gym!`
    };
  }

  generateMembershipExpiringEmail(user, membership) {
    const daysLeft = membership.daysUntilExpiration();
    const html = `
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>‚ö†Ô∏è Tu membres√≠a est√° por vencer</title>
        <style>
          body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f4f4; }
          .container { max-width: 600px; margin: 0 auto; background-color: #ffffff; }
          .header { background-color: #e74c3c; color: #ffffff; padding: 20px; text-align: center; }
          .content { padding: 30px; }
          .alert-box { background-color: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 5px; margin: 15px 0; }
          .button { display: inline-block; background-color: #e74c3c; color: #ffffff; padding: 15px 30px; text-decoration: none; border-radius: 5px; margin: 20px 0; font-weight: bold; }
          .info-box { background-color: #f8f9fa; padding: 15px; border-radius: 5px; margin: 15px 0; }
          .footer { background-color: #ecf0f1; padding: 15px; text-align: center; font-size: 12px; color: #7f8c8d; }
        </style>
      </head>
      <body>
        <div class="container">
          <div class="header">
            <h1>‚ö†Ô∏è Tu membres√≠a est√° por vencer</h1>
          </div>
          <div class="content">
            <h2>¬°Hola ${user.getFullName()}!</h2>
            
            <div class="alert-box">
              <h3>üö® Atenci√≥n: Tu membres√≠a ${membership.type === 'monthly' ? 'mensual' : 'diaria'} vence en <strong>${daysLeft} d√≠a${daysLeft !== 1 ? 's' : ''}</strong></h3>
            </div>
            
            <div class="info-box">
              <p><strong>üìÖ Fecha de vencimiento:</strong> ${new Date(membership.endDate).toLocaleDateString('es-ES', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
              })}</p>
              <p><strong>üí∞ Precio actual:</strong> $${membership.price}</p>
              <p><strong>üèãÔ∏è‚Äç‚ôÇÔ∏è Tipo de membres√≠a:</strong> ${membership.type === 'monthly' ? 'Mensual' : 'Diaria'}</p>
            </div>
            
            <p>Para continuar disfrutando de nuestras instalaciones y servicios sin interrupciones, renueva tu membres√≠a antes de la fecha de vencimiento.</p>
            
            <p style="text-align: center;">
              <a href="${process.env.FRONTEND_URL}/renovar-membresia?id=${membership.id}" class="button">üîÑ Renovar Membres√≠a Ahora</a>
            </p>
            
            <p>¬øNecesitas ayuda? Cont√°ctanos:</p>
            <ul>
              <li>üìû Tel√©fono: ${process.env.GYM_PHONE || 'Contacta recepci√≥n'}</li>
              <li>üìß Email: ${process.env.GMAIL_USER}</li>
              <li>üè¢ Vis√≠tanos en recepci√≥n</li>
            </ul>
            
            <p><strong>¬°Te esperamos para seguir entrenando juntos! üí™</strong></p>
          </div>
          <div class="footer">
            <p>Elite Fitness Club - Tu mejor versi√≥n te est√° esperando</p>
            <p>üìß ${process.env.GMAIL_USER} | üìû ${process.env.GYM_PHONE || 'Contacta recepci√≥n'}</p>
          </div>
        </div>
      </body>
      </html>
    `;
    
    return {
      subject: `‚ö†Ô∏è Tu membres√≠a vence en ${daysLeft} d√≠a${daysLeft !== 1 ? 's' : ''} - Renueva ahora`,
      html,
      text: `Hola ${user.getFullName()}, tu membres√≠a vence en ${daysLeft} d√≠as (${new Date(membership.endDate).toLocaleDateString('es-ES')}). Renueva para continuar entrenando con nosotros.`
    };
  }

  generateMembershipExpiredEmail(user, membership) {
    const html = `
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>üö® Tu membres√≠a ha vencido</title>
        <style>
          body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f4f4; }
          .container { max-width: 600px; margin: 0 auto; background-color: #ffffff; }
          .header { background-color: #c0392b; color: #ffffff; padding: 20px; text-align: center; }
          .content { padding: 30px; }
          .expired-box { background-color: #f8d7da; border: 1px solid #f5c6cb; padding: 15px; border-radius: 5px; margin: 15px 0; }
          .button { display: inline-block; background-color: #e74c3c; color: #ffffff; padding: 15px 30px; text-decoration: none; border-radius: 5px; margin: 20px 0; font-weight: bold; }
          .comeback-box { background-color: #d1ecf1; padding: 15px; border-radius: 5px; margin: 15px 0; }
          .footer { background-color: #ecf0f1; padding: 15px; text-align: center; font-size: 12px; color: #7f8c8d; }
        </style>
      </head>
      <body>
        <div class="container">
          <div class="header">
            <h1>üö® Tu membres√≠a ha vencido</h1>
          </div>
          <div class="content">
            <h2>¬°Hola ${user.getFullName()}!</h2>
            
            <div class="expired-box">
              <h3>‚è∞ Tu membres√≠a ${membership.type === 'monthly' ? 'mensual' : 'diaria'} venci√≥ el <strong>${new Date(membership.endDate).toLocaleDateString('es-ES')}</strong></h3>
            </div>
            
            <p>Sabemos que el fitness es importante para ti, y queremos que regreses a entrenar lo antes posible.</p>
            
            <div class="comeback-box">
              <h3>üéØ ¬øPor qu√© renovar ahora?</h3>
              <ul>
                <li>üèãÔ∏è‚Äç‚ôÇÔ∏è Mant√©n tu rutina de ejercicios sin interrupciones</li>
                <li>üí™ No pierdas el progreso que has logrado</li>
                <li>üë• Sigue siendo parte de nuestra comunidad fitness</li>
                <li>üÜï Accede a nuevos equipos y clases</li>
              </ul>
            </div>
            
            <p style="text-align: center;">
              <a href="${process.env.FRONTEND_URL}/renovar-membresia?id=${membership.id}" class="button">üí≥ Renovar Ahora</a>
            </p>
            
            <p>Si tienes alguna pregunta o necesitas ayuda con tu renovaci√≥n, no dudes en contactarnos. ¬°Estamos aqu√≠ para apoyarte!</p>
            
            <p><strong>¬°Te extra√±amos y esperamos verte pronto de vuelta! üíô</strong></p>
          </div>
          <div class="footer">
            <p>Elite Fitness Club - Tu mejor versi√≥n te est√° esperando</p>
            <p>üìß ${process.env.GMAIL_USER} | üìû ${process.env.GYM_PHONE || 'Contacta recepci√≥n'}</p>
          </div>
        </div>
      </body>
      </html>
    `;
    
    return {
      subject: 'üö® Tu membres√≠a ha vencido - ¬°Te extra√±amos!',
      html,
      text: `Hola ${user.getFullName()}, tu membres√≠a venci√≥ el ${new Date(membership.endDate).toLocaleDateString('es-ES')}. Renueva para continuar entrenando. ¬°Te extra√±amos!`
    };
  }

 generatePaymentConfirmationEmail(user, payment) {
    console.log('üìß Generando email de confirmaci√≥n de compra...');
    console.log('üë§ Usuario:', user ? user.email || user.getFullName?.() || 'Usuario' : 'Invitado');
    console.log('üí∞ Pago:', {
      id: payment.id,
      amount: payment.amount,
      paymentType: payment.paymentType,
      paymentMethod: payment.paymentMethod
    });

    // ‚úÖ Determinar tipo de pago para personalizar el mensaje
    let paymentTypeName = 'Compra';
    let paymentIcon = 'üõçÔ∏è';
    let paymentDescription = 'Tu compra';

    switch (payment.paymentType) {
      case 'membership':
        paymentTypeName = 'Membres√≠a mensual';
        paymentIcon = 'üé´';
        paymentDescription = 'Tu membres√≠a';
        break;
      case 'daily':
        paymentTypeName = 'Entrada diaria';
        paymentIcon = 'üèÉ‚Äç‚ôÇÔ∏è';
        paymentDescription = 'Tu entrada diaria';
        break;
      case 'store_online':
      case 'store_cash_delivery':
      case 'store_card_delivery':
        paymentTypeName = 'Productos de tienda';
        paymentIcon = 'üõçÔ∏è';
        paymentDescription = 'Tu compra de productos';
        break;
      default:
        paymentTypeName = 'Pago';
        paymentIcon = 'üí≥';
        paymentDescription = 'Tu pago';
    }

    // ‚úÖ HTML mejorado para email de confirmaci√≥n
    const html = `
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>‚úÖ Confirmaci√≥n de compra - Elite Fitness Club</title>
        <style>
          body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f4f4; }
          .container { max-width: 600px; margin: 0 auto; background-color: #ffffff; }
          .header { background: linear-gradient(135deg, #27ae60 0%, #229954 100%); color: #ffffff; padding: 30px; text-align: center; }
          .content { padding: 30px; }
          .success-box { background-color: #d4edda; border: 2px solid #c3e6cb; padding: 20px; border-radius: 8px; margin: 20px 0; text-align: center; }
          .payment-details { background-color: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0; }
          .button { display: inline-block; background-color: #27ae60; color: #ffffff; padding: 15px 30px; text-decoration: none; border-radius: 8px; margin: 20px 0; font-weight: bold; }
          .footer { background-color: #ecf0f1; padding: 20px; text-align: center; font-size: 12px; color: #7f8c8d; }
          .highlight { background-color: #fff3cd; padding: 15px; border-radius: 5px; margin: 15px 0; border-left: 4px solid #ffc107; }
        </style>
      </head>
      <body>
        <div class="container">
          <!-- Header de confirmaci√≥n exitosa -->
          <div class="header">
            <h1>${paymentIcon} ¬°Compra confirmada!</h1>
            <p style="margin: 10px 0 0 0; font-size: 18px;">
              ${paymentDescription} ha sido procesada exitosamente
            </p>
          </div>

          <!-- Contenido principal -->
          <div class="content">
            
            <!-- Mensaje de √©xito -->
            <div class="success-box">
              <h2 style="color: #155724; margin: 0 0 15px 0;">
                ‚úÖ ¬°Pago confirmado exitosamente!
              </h2>
              <p style="color: #155724; margin: 0; font-size: 16px;">
                Hola <strong>${user ? (user.getFullName?.() || user.email || 'Cliente') : 'Cliente'}</strong>, 
                hemos confirmado tu pago. ¬°Gracias por tu compra!
              </p>
            </div>

            <!-- Detalles del pago -->
            <div class="payment-details">
              <h3 style="color: #2c3e50; margin: 0 0 15px 0;">üìã Detalles del pago</h3>
              <table style="width: 100%; border-collapse: collapse;">
                <tr>
                  <td style="padding: 8px 0; color: #495057; font-weight: bold;">üí∞ Monto:</td>
                  <td style="padding: 8px 0; color: #2c3e50; font-size: 18px; font-weight: bold;">$${payment.amount}</td>
                </tr>
                <tr>
                  <td style="padding: 8px 0; color: #495057; font-weight: bold;">${paymentIcon} Concepto:</td>
                  <td style="padding: 8px 0; color: #2c3e50;">${paymentTypeName}</td>
                </tr>
                <tr>
                  <td style="padding: 8px 0; color: #495057; font-weight: bold;">üí≥ M√©todo de pago:</td>
                  <td style="padding: 8px 0; color: #2c3e50;">${this.getPaymentMethodName(payment.paymentMethod)}</td>
                </tr>
                <tr>
                  <td style="padding: 8px 0; color: #495057; font-weight: bold;">üìÖ Fecha:</td>
                  <td style="padding: 8px 0; color: #2c3e50;">${new Date(payment.paymentDate || new Date()).toLocaleDateString('es-ES', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                  })}</td>
                </tr>
                ${payment.paymentType === 'membership' ? 
                  '<tr><td style="padding: 8px 0; color: #495057; font-weight: bold;">üîÑ Estado:</td><td style="padding: 8px 0; color: #27ae60; font-weight: bold;">‚úÖ Membres√≠a renovada exitosamente</td></tr>' : 
                  ''}
                ${payment.cardLast4 ? 
                  `<tr><td style="padding: 8px 0; color: #495057; font-weight: bold;">üí≥ Tarjeta:</td><td style="padding: 8px 0; color: #2c3e50;">**** **** **** ${payment.cardLast4}</td></tr>` : 
                  ''}
                ${payment.id ? 
                  `<tr><td style="padding: 8px 0; color: #495057; font-weight: bold;">üÜî ID de pago:</td><td style="padding: 8px 0; color: #6c757d; font-size: 12px;">${payment.id}</td></tr>` : 
                  ''}
              </table>
            </div>

            <!-- Informaci√≥n espec√≠fica seg√∫n tipo de pago -->
            ${this.generateSpecificPaymentInfo(payment)}

            <!-- Pr√≥ximos pasos -->
            <div class="highlight">
              <h3 style="color: #856404; margin: 0 0 10px 0;">üìã Pr√≥ximos pasos</h3>
              ${this.generateNextStepsInfo(payment)}
            </div>

            <!-- Bot√≥n de acci√≥n -->
            <div style="text-align: center; margin: 30px 0;">
              <a href="${process.env.FRONTEND_URL || '#'}" class="button">
                üè† Ir a mi cuenta
              </a>
            </div>

            <!-- Informaci√≥n de contacto -->
            <div style="background-color: #e8f4fd; padding: 20px; border-radius: 8px; margin: 20px 0;">
              <h3 style="color: #0c5460; margin: 0 0 10px 0;">üìû ¬øNecesitas ayuda?</h3>
              <p style="color: #0c5460; margin: 0;">
                Si tienes alguna pregunta sobre este pago, no dudes en contactarnos:
              </p>
              <ul style="color: #0c5460; margin: 10px 0;">
                <li>üìß Email: ${process.env.GMAIL_USER || 'info@elitefitnessclub.com'}</li>
                <li>üìû Tel√©fono: ${process.env.GYM_PHONE || 'Contacta recepci√≥n'}</li>
                <li>üè¢ Vis√≠tanos en recepci√≥n</li>
                <li>üí¨ WhatsApp: Responde a este email</li>
              </ul>
            </div>

            <!-- Mensaje de agradecimiento -->
            <div style="text-align: center; margin: 30px 0;">
              <h3 style="color: #2c3e50;">üôè ¬°Gracias por confiar en Elite Fitness Club!</h3>
              <p style="color: #6c757d;">
                Estamos comprometidos en ayudarte a alcanzar tus objetivos fitness.
              </p>
            </div>

          </div>

          <!-- Footer -->
          <div class="footer">
            <p><strong>Elite Fitness Club</strong> - Tu mejor versi√≥n te est√° esperando</p>
            <p>üìß ${process.env.GMAIL_USER || 'info@elitefitnessclub.com'} | üìû ${process.env.GYM_PHONE || 'Contacta recepci√≥n'}</p>
            <p>Este es un email autom√°tico de confirmaci√≥n de pago. Por favor no respondas a este mensaje.</p>
            <p>¬© ${new Date().getFullYear()} Elite Fitness Club. Todos los derechos reservados.</p>
          </div>

        </div>
      </body>
      </html>
    `;

    // ‚úÖ Texto plano mejorado
    const text = `‚úÖ ¬°PAGO CONFIRMADO! - Elite Fitness Club

Hola ${user ? (user.getFullName?.() || user.email || 'Cliente') : 'Cliente'},

¬°Hemos confirmado tu pago exitosamente! Gracias por tu compra.

üìã DETALLES DEL PAGO:
üí∞ Monto: $${payment.amount}
${paymentIcon} Concepto: ${paymentTypeName}
üí≥ M√©todo: ${this.getPaymentMethodName(payment.paymentMethod)}
üìÖ Fecha: ${new Date(payment.paymentDate || new Date()).toLocaleString('es-ES')}
${payment.cardLast4 ? `üí≥ Tarjeta: **** **** **** ${payment.cardLast4}` : ''}
${payment.id ? `üÜî ID: ${payment.id}` : ''}

${this.generateSpecificPaymentInfoText(payment)}

üìû CONTACTO:
üìß Email: ${process.env.GMAIL_USER || 'info@elitefitnessclub.com'}
üìû Tel√©fono: ${process.env.GYM_PHONE || 'Contacta recepci√≥n'}

üôè ¬°Gracias por confiar en Elite Fitness Club!

---
Elite Fitness Club - Tu mejor versi√≥n te est√° esperando
¬© ${new Date().getFullYear()} Elite Fitness Club`;

    console.log('‚úÖ Email de confirmaci√≥n generado exitosamente');

    return {
      subject: `‚úÖ Pago confirmado - ${paymentTypeName} - Elite Fitness Club`,
      html,
      text
    };
  }

  // ‚úÖ NUEVO: Generar informaci√≥n espec√≠fica seg√∫n tipo de pago (HTML)
  generateSpecificPaymentInfo(payment) {
    switch (payment.paymentType) {
      case 'membership':
        return `
          <div style="background-color: #d1ecf1; padding: 20px; border-radius: 8px; margin: 20px 0;">
            <h3 style="color: #0c5460; margin: 0 0 15px 0;">üé´ Tu membres√≠a est√° activa</h3>
            <ul style="color: #0c5460; margin: 0; padding-left: 20px;">
              <li>‚úÖ Ya puedes acceder a todas las instalaciones</li>
              <li>üèãÔ∏è‚Äç‚ôÇÔ∏è Disfruta de todos los equipos y √°reas</li>
              <li>üë• √önete a las clases grupales disponibles</li>
              <li>üì± Revisa tu membres√≠a en tu perfil online</li>
            </ul>
          </div>
        `;
      case 'daily':
        return `
          <div style="background-color: #d1ecf1; padding: 20px; border-radius: 8px; margin: 20px 0;">
            <h3 style="color: #0c5460; margin: 0 0 15px 0;">üèÉ‚Äç‚ôÇÔ∏è Tu entrada diaria est√° confirmada</h3>
            <ul style="color: #0c5460; margin: 0; padding-left: 20px;">
              <li>‚úÖ Puedes acceder al gimnasio hoy</li>
              <li>üí™ Disfruta tu entrenamiento al m√°ximo</li>
              <li>üîÑ Considera una membres√≠a mensual para ahorrar</li>
              <li>üí° Pregunta por nuestras promociones especiales</li>
            </ul>
          </div>
        `;
      case 'store_online':
      case 'store_cash_delivery':
      case 'store_card_delivery':
        return `
          <div style="background-color: #d1ecf1; padding: 20px; border-radius: 8px; margin: 20px 0;">
            <h3 style="color: #0c5460; margin: 0 0 15px 0;">üõçÔ∏è Tu pedido est√° siendo procesado</h3>
            <ul style="color: #0c5460; margin: 0; padding-left: 20px;">
              <li>üì¶ Prepararemos tu pedido en las pr√≥ximas horas</li>
              <li>üì± Te contactaremos cuando est√© listo</li>
              <li>üöö Recibir√°s actualizaciones del estado del env√≠o</li>
              <li>üí° Guarda este email como comprobante</li>
            </ul>
          </div>
        `;
      default:
        return `
          <div style="background-color: #d1ecf1; padding: 20px; border-radius: 8px; margin: 20px 0;">
            <h3 style="color: #0c5460; margin: 0 0 15px 0;">üí≥ Pago procesado exitosamente</h3>
            <ul style="color: #0c5460; margin: 0; padding-left: 20px;">
              <li>‚úÖ Tu pago ha sido confirmado y registrado</li>
              <li>üìß Guarda este email como comprobante</li>
              <li>üìû Contacta si tienes alguna pregunta</li>
            </ul>
          </div>
        `;
    }
  }

  // ‚úÖ NUEVO: Generar pr√≥ximos pasos seg√∫n tipo de pago
  generateNextStepsInfo(payment) {
    switch (payment.paymentType) {
      case 'membership':
        return `
          <div style="color: #856404;">
            <p><strong>üéØ ¬°Ya puedes entrenar!</strong></p>
            <ul style="margin: 10px 0; padding-left: 20px;">
              <li>Visita el gimnasio con tu documento de identidad</li>
              <li>Revisa los horarios de clases grupales</li>
              <li>Programa tu rutina de entrenamiento</li>
              <li>Explora todas las instalaciones disponibles</li>
            </ul>
          </div>
        `;
      case 'daily':
        return `
          <div style="color: #856404;">
            <p><strong>üèÉ‚Äç‚ôÇÔ∏è ¬°Disfruta tu entrenamiento de hoy!</strong></p>
            <ul style="margin: 10px 0; padding-left: 20px;">
              <li>Presenta este comprobante en recepci√≥n</li>
              <li>Aprovecha todas las instalaciones hoy</li>
              <li>Pregunta por las clases grupales del d√≠a</li>
              <li>Considera una membres√≠a mensual para ahorrar</li>
            </ul>
          </div>
        `;
      case 'store_online':
      case 'store_cash_delivery':
      case 'store_card_delivery':
        return `
          <div style="color: #856404;">
            <p><strong>üì¶ ¬°Tu pedido est√° en proceso!</strong></p>
            <ul style="margin: 10px 0; padding-left: 20px;">
              <li>Recibir√°s actualizaciones por WhatsApp/SMS</li>
              <li>Te contactaremos para coordinar la entrega</li>
              <li>Ten tu documento de identidad listo</li>
              <li>Verifica que la direcci√≥n sea correcta</li>
            </ul>
          </div>
        `;
      default:
        return `
          <div style="color: #856404;">
            <p><strong>‚úÖ ¬°Todo est√° listo!</strong></p>
            <ul style="margin: 10px 0; padding-left: 20px;">
              <li>Tu pago ha sido procesado exitosamente</li>
              <li>Guarda este comprobante para tus records</li>
              <li>Contacta si tienes alguna pregunta</li>
            </ul>
          </div>
        `;
    }
  }

  // ‚úÖ NUEVO: Generar informaci√≥n espec√≠fica para texto plano
  generateSpecificPaymentInfoText(payment) {
    switch (payment.paymentType) {
      case 'membership':
        return `
üé´ TU MEMBRES√çA EST√Å ACTIVA:
‚úÖ Ya puedes acceder a todas las instalaciones
üèãÔ∏è‚Äç‚ôÇÔ∏è Disfruta de todos los equipos y √°reas
üë• √önete a las clases grupales disponibles
üì± Revisa tu membres√≠a en tu perfil online`;
      case 'daily':
        return `
üèÉ‚Äç‚ôÇÔ∏è TU ENTRADA DIARIA CONFIRMADA:
    ‚úÖ Puedes acceder al gimnasio hoy
    üí™ Disfruta tu entrenamiento al m√°ximo
    üîÑ Considera una membres√≠a mensual para ahorrar`;
          case 'store_online':
          case 'store_cash_delivery':
          case 'store_card_delivery':
            return `
    üõçÔ∏è TU PEDIDO EN PROCESO:
    üì¶ Prepararemos tu pedido en las pr√≥ximas horas
    üì± Te contactaremos cuando est√© listo
    üöö Recibir√°s actualizaciones del env√≠o`;
          default:
            return `
    üí≥ PAGO PROCESADO:
    ‚úÖ Tu pago ha sido confirmado y registrado
    üìß Guarda este email como comprobante`;
        }
      }

  getPaymentMethodName(method) {
    const methods = {
      cash: 'Efectivo',
      card: 'Tarjeta',
      transfer: 'Transferencia bancaria',
      online: 'Pago en l√≠nea'
    };
    return methods[method] || method;
  }

  // M√©todo para obtener estad√≠sticas b√°sicas (mejorado)
  async getEmailStats() {
    try {
      if (!this.isConfigured) {
        return { success: false, message: 'Gmail no configurado' };
      }

      // Informaci√≥n b√°sica del servicio
      return {
        success: true,
        stats: {
          provider: 'Gmail',
          senderEmail: process.env.GMAIL_USER,
          senderName: process.env.GMAIL_SENDER_NAME || 'Elite Fitness Club',
          configured: true,
          verified: this.isConfigured,
          host: 'smtp.gmail.com',
          port: 465,
          secure: true
        }
      };
    } catch (error) {
      console.error('Error al obtener estad√≠sticas de Gmail:', error);
      return { success: false, error: error.message };
    }
  }

  // NUEVO: M√©todo para enviar email con archivo adjunto
  async sendEmailWithAttachment({ to, subject, html, text, attachmentPath, attachmentName }) {
    try {
      const attachments = attachmentPath ? [{
        filename: attachmentName || 'archivo.pdf',
        path: attachmentPath
      }] : null;

      return await this.sendEmail({ to, subject, html, text, attachments });
    } catch (error) {
      console.error('Error al enviar email con adjunto:', error);
      return { success: false, error: error.message };
    }
  }

  // ‚úÖ NUEVO: M√©todo para probar el servicio manualmente
  async testEmailService() {
    try {
      console.log('üß™ Iniciando prueba manual del servicio de Gmail...');
      
      if (!this.isConfigured) {
        console.log('‚ùå No se puede probar: Gmail no configurado');
        return { success: false, message: 'Gmail no configurado' };
      }

      // Verificar conexi√≥n (con email de prueba)
      const verifyResult = await this.verifyConfiguration(true); // true = enviar email de prueba
      if (!verifyResult) {
        console.log('‚ùå No se puede probar: Error en verificaci√≥n');
        return { success: false, message: 'Error en verificaci√≥n de configuraci√≥n' };
      }

      // Enviar email de prueba
      const testResult = await this.sendTestEmail();
      
      if (testResult.success) {
        console.log('‚úÖ Prueba del servicio Gmail completada exitosamente');
        console.log('   üìß Email de prueba enviado a:', process.env.GMAIL_USER);
        console.log('   üì¨ Revisa tu bandeja de entrada para confirmar');
        return {
          success: true,
          message: 'Servicio Gmail funcionando correctamente',
          details: {
            messageId: testResult.messageId,
            testEmailSent: true,
            recipientEmail: process.env.GMAIL_USER
          }
        };
      } else {
        console.log('‚ùå Fallo en env√≠o de email de prueba:', testResult.error);
        return {
          success: false,
          message: 'Error al enviar email de prueba',
          error: testResult.error
        };
      }
    } catch (error) {
      console.error('‚ùå Error en prueba del servicio Gmail:', error);
      return {
        success: false,
        message: 'Error en prueba del servicio',
        error: error.message
      };
    }
  }
}

// WhatsAppService se mantiene igual (sin cambios)
class WhatsAppService {
  constructor() {
    // El servicio de WhatsApp permanece igual usando Twilio
    const hasValidCredentials = 
      process.env.TWILIO_ACCOUNT_SID && 
      process.env.TWILIO_AUTH_TOKEN &&
      process.env.TWILIO_ACCOUNT_SID.startsWith('AC') &&
      process.env.TWILIO_ACCOUNT_SID !== 'your_twilio_account_sid';

    if (hasValidCredentials) {
      try {
        this.client = twilio(
          process.env.TWILIO_ACCOUNT_SID,
          process.env.TWILIO_AUTH_TOKEN
        );
        console.log('‚úÖ Cliente de Twilio (WhatsApp) inicializado correctamente');
      } catch (error) {
        console.warn('‚ö†Ô∏è Error al inicializar Twilio:', error.message);
        this.client = null;
      }
    } else {
      console.warn('‚ö†Ô∏è Twilio no configurado correctamente - WhatsApp no funcionar√°');
      if (process.env.TWILIO_ACCOUNT_SID && !process.env.TWILIO_ACCOUNT_SID.startsWith('AC')) {
        console.warn('   TWILIO_ACCOUNT_SID debe comenzar con "AC"');
      }
      this.client = null;
    }
  }

  async sendWhatsApp({ to, message }) {
    try {
      if (!process.env.NOTIFICATION_WHATSAPP_ENABLED || process.env.NOTIFICATION_WHATSAPP_ENABLED !== 'true') {
        console.log('üì± WhatsApp deshabilitado en configuraci√≥n');
        return { success: false, message: 'WhatsApp deshabilitado' };
      }

      if (!this.client) {
        console.log('üì± Cliente de Twilio no disponible');
        return { success: false, message: 'Cliente de Twilio no configurado correctamente' };
      }

      const formattedTo = this.formatPhoneNumber(to);
      
      const result = await this.client.messages.create({
        from: process.env.TWILIO_WHATSAPP_FROM || 'whatsapp:+14155238886',
        to: `whatsapp:${formattedTo}`,
        body: message
      });

      console.log('‚úÖ WhatsApp enviado:', result.sid);
      return { success: true, messageId: result.sid };
    } catch (error) {
      console.error('‚ùå Error al enviar WhatsApp:', error);
      return { success: false, error: error.message };
    }
  }

  formatPhoneNumber(phone) {
    let cleaned = phone.replace(/\D/g, '');
    
    if (cleaned.length === 8) {
      cleaned = '502' + cleaned; // C√≥digo de Guatemala
    }
    
    if (!cleaned.startsWith('+')) {
      cleaned = '+' + cleaned;
    }
    
    return cleaned;
  }

  // Templates de WhatsApp (permanecen igual)
  generateWelcomeMessage(user) {
    return `¬°Hola ${user.getFullName()}! üèãÔ∏è‚Äç‚ôÇÔ∏è

¬°Bienvenido al Elite Fitness Club! Estamos emocionados de tenerte en nuestra familia fitness.

Tu cuenta ha sido creada exitosamente. ¬°Nos vemos en el gym! üí™

üîó Accede a tu cuenta: ${process.env.FRONTEND_URL || 'Visita nuestra recepci√≥n'}`;
  }

  generateMembershipExpiringMessage(user, membership) {
    const daysLeft = membership.daysUntilExpiration();
    return `‚ö†Ô∏è Hola ${user.getFullName()}!

Tu membres√≠a ${membership.type === 'monthly' ? 'mensual' : 'diaria'} vence en *${daysLeft} d√≠a${daysLeft !== 1 ? 's' : ''}*.

üìÖ Fecha de vencimiento: ${new Date(membership.endDate).toLocaleDateString('es-ES')}

Renueva tu membres√≠a para seguir entrenando con nosotros. ¬°Te esperamos! üèÉ‚Äç‚ôÄÔ∏è

üí≥ Renovar: ${process.env.FRONTEND_URL}/renovar-membresia`;
  }

  generateMembershipExpiredMessage(user, membership) {
    return `üö® Hola ${user.getFullName()}!

Tu membres√≠a ${membership.type === 'monthly' ? 'mensual' : 'diaria'} venci√≥ el *${new Date(membership.endDate).toLocaleDateString('es-ES')}*.

Renueva tu membres√≠a hoy mismo para continuar entrenando. ¬°Te extra√±amos! üíô

üí≥ Renovar ahora: ${process.env.FRONTEND_URL}/renovar-membresia`;
  }

  generatePaymentConfirmationMessage(user, payment) {
    return `‚úÖ ¬°Pago confirmado!

Hola ${user.getFullName()}, hemos confirmado tu pago de *$${payment.amount}* por ${payment.paymentType === 'membership' ? 'membres√≠a mensual' : 'entrada diaria'}.

üìÖ Fecha: ${new Date(payment.paymentDate).toLocaleDateString('es-ES')}
üí≥ M√©todo: ${this.getPaymentMethodName(payment.paymentMethod)}

${payment.paymentType === 'membership' ? 'üéâ ¬°Tu membres√≠a ha sido renovada!' : 'üí™ ¬°Disfruta tu entrenamiento!'}

¬°Gracias por confiar en Elite Fitness Club!`;
  }

  generatePromotionMessage(user, promotion) {
    return `üéâ ¬°Oferta especial para ti!

Hola ${user.getFullName()}, tenemos una promoci√≥n incre√≠ble:

${promotion}

¬°No dejes pasar esta oportunidad! üèÉ‚Äç‚ôÇÔ∏èüí®

Para m√°s info vis√≠tanos o escr√≠benos.`;
  }

  generateMotivationalMessage(user) {
    const messages = [
      `üí™ ¬°Hola ${user.getFullName()}! Recuerda que cada d√≠a es una nueva oportunidad para ser mejor. ¬°Te esperamos en el gym!`,
      `üèãÔ∏è‚Äç‚ôÄÔ∏è ${user.getFullName()}, tu cuerpo puede hacerlo. ¬°Es tu mente la que tienes que convencer! ¬°Vamos!`,
      `üî• ¬°${user.getFullName()}! El √∫nico entrenamiento malo es el que no haces. ¬°Nos vemos hoy!`,
      `‚≠ê Hola ${user.getFullName()}, cada repetici√≥n te acerca m√°s a tu mejor versi√≥n. ¬°Sigue as√≠!`,
      `üéØ ${user.getFullName()}, el √©xito no es solo el destino, es el viaje. ¬°Sigue entrenando!`,
      `üíØ ¬°${user.getFullName()}! Los l√≠mites est√°n solo en tu mente. ¬°R√≥mpelos hoy en el gym!`
    ];
    
    return messages[Math.floor(Math.random() * messages.length)];
  }

  getPaymentMethodName(method) {
    const methods = {
      cash: 'Efectivo',
      card: 'Tarjeta',
      transfer: 'Transferencia',
      online: 'Pago en l√≠nea'
    };
    return methods[method] || method;
  }
}

module.exports = {
  EmailService,
  WhatsAppService
};