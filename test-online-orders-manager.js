// test-online-orders-manager.js - GESTOR COMPLETO DE PEDIDOS ONLINE
// Elite Fitness - Sistema de gesti√≥n de pedidos con flujos espec√≠ficos por tipo
const axios = require('axios');
const readline = require('readline');
require('dotenv').config();

/**
 * GESTOR DE PEDIDOS ONLINE
 * 
 * Funcionalidades:
 * - Flujos espec√≠ficos por tipo de entrega (delivery, express, pickup)
 * - Validaci√≥n OBLIGATORIA de transferencias antes de preparar
 * - Pagos con tarjeta online: autom√°ticos (sin confirmaci√≥n)
 * - Pagos en efectivo: confirmaci√≥n al entregar
 * - Tracking obligatorio para env√≠os
 * - Gesti√≥n paso a paso de estados
 */
class OnlineOrdersManager {
  constructor(baseURL = 'http://localhost:5000') {
    this.baseURL = baseURL;
    this.adminToken = null;
    
    // Datos cargados
    this.pendingOrders = [];
    this.allOrders = [];
    this.products = [];
    this.dashboard = null;
    
    // Configurar readline
    this.rl = readline.createInterface({
      input: process.stdin,
      output: process.stdout
    });

    // ============================================================================
    // DEFINICI√ìN DE FLUJOS DE TRABAJO
    // ============================================================================
    this.workflows = {
      delivery: {
        name: 'Env√≠o a Domicilio',
        icon: 'üöö',
        steps: [
          { 
            status: 'pending', 
            name: 'Pendiente', 
            next: 'confirmed',
            description: 'Pedido recibido, esperando confirmaci√≥n'
          },
          { 
            status: 'confirmed', 
            name: 'Confirmado', 
            next: 'preparing', 
            requiresTransferValidation: true,
            description: 'Pedido confirmado. Si es transferencia, debe validarse antes de preparar'
          },
          { 
            status: 'preparing', 
            name: 'En Preparaci√≥n', 
            next: 'packed',
            description: 'Preparando productos para env√≠o'
          },
          { 
            status: 'packed', 
            name: 'Empacado', 
            next: 'shipped', 
            requiresTracking: true,
            description: 'Pedido empacado, listo para enviar. Requiere n√∫mero de gu√≠a'
          },
          { 
            status: 'shipped', 
            name: 'Enviado', 
            next: 'delivered',
            description: 'Pedido en ruta hacia el cliente'
          },
          { 
            status: 'delivered', 
            name: 'Entregado', 
            requiresCashPayment: true,
            description: 'Pedido entregado al cliente. Confirmar pago si es contra entrega'
          }
        ]
      },
      express: {
        name: 'Env√≠o Express',
        icon: '‚ö°',
        steps: [
          { 
            status: 'pending', 
            name: 'Pendiente', 
            next: 'confirmed',
            description: 'Pedido express recibido - PRIORIDAD ALTA'
          },
          { 
            status: 'confirmed', 
            name: 'Confirmado', 
            next: 'preparing', 
            requiresTransferValidation: true,
            description: 'Pedido confirmado. Si es transferencia, debe validarse antes de preparar'
          },
          { 
            status: 'preparing', 
            name: 'En Preparaci√≥n', 
            next: 'packed',
            description: 'Preparando productos (2-4 horas)'
          },
          { 
            status: 'packed', 
            name: 'Empacado', 
            next: 'shipped', 
            requiresTracking: true,
            description: 'Empacado y listo para env√≠o express'
          },
          { 
            status: 'shipped', 
            name: 'Enviado', 
            next: 'delivered',
            description: 'En ruta express hacia el cliente'
          },
          { 
            status: 'delivered', 
            name: 'Entregado', 
            requiresCashPayment: true,
            description: 'Entregado. Confirmar pago si es contra entrega'
          }
        ]
      },
      pickup: {
        name: 'Recoger en Tienda',
        icon: 'üè™',
        steps: [
          { 
            status: 'pending', 
            name: 'Pendiente', 
            next: 'confirmed',
            description: 'Pedido para recoger recibido'
          },
          { 
            status: 'confirmed', 
            name: 'Confirmado', 
            next: 'preparing', 
            requiresTransferValidation: true,
            description: 'Pedido confirmado. Si es transferencia, debe validarse antes de preparar'
          },
          { 
            status: 'preparing', 
            name: 'En Preparaci√≥n', 
            next: 'packed',
            description: 'Preparando productos para recoger'
          },
          { 
            status: 'packed', 
            name: 'Empacado', 
            next: 'ready_pickup',
            description: 'Empacado y listo para que el cliente recoja'
          },
          { 
            status: 'ready_pickup', 
            name: 'Listo para Recoger', 
            next: 'picked_up', 
            requiresCashPayment: true,
            description: 'Cliente puede recoger. Verificar identidad y confirmar pago si es en tienda'
          },
          { 
            status: 'picked_up', 
            name: 'Recogido',
            description: 'Cliente recogi√≥ el pedido exitosamente'
          }
        ]
      }
    };
  }

  // ============================================================================
  // INICIO Y AUTENTICACI√ìN
  // ============================================================================

  async start() {
    console.log('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
    console.log('‚ïë           üõí ELITE FITNESS - GESTOR DE PEDIDOS ONLINE V2.0                ‚ïë');
    console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');
    console.log('\nüì¶ CARACTER√çSTICAS DEL SISTEMA:');
    console.log('   ‚úÖ Flujos espec√≠ficos por tipo de entrega');
    console.log('   ‚úÖ Gesti√≥n paso a paso de estados');
    console.log('   üè¶ Validaci√≥n OBLIGATORIA de transferencias antes de preparar');
    console.log('   üí≥ Pagos con tarjeta online: autom√°ticos (sin confirmaci√≥n)');
    console.log('   üí∞ Pagos en efectivo: confirmaci√≥n al entregar');
    console.log('   üì¶ Tracking obligatorio para env√≠os');
    console.log('   üîÑ Actualizaci√≥n en tiempo real\n');
    
    try {
      await this.loginAdmin();
      await this.loadAllData();
      await this.showMainMenu();
      
    } catch (error) {
      console.error('\n‚ùå ERROR CR√çTICO:', error.message);
      if (error.response) {
        console.error('üìã Detalles del servidor:', error.response.data);
      }
    } finally {
      this.rl.close();
    }
  }

  async loginAdmin() {
    console.log('üîê Autenticando como administrador...');
    
    try {
      const response = await axios.post(`${this.baseURL}/api/auth/login`, {
        email: 'admin@gym.com',
        password: 'Admin123!'
      });

      if (response.data.success && response.data.data.token) {
        this.adminToken = response.data.data.token;
        console.log(`   ‚úÖ Sesi√≥n iniciada: ${response.data.data.user.firstName} ${response.data.data.user.lastName}`);
        console.log(`   üë§ Rol: ${response.data.data.user.role.toUpperCase()}`);
      }
    } catch (error) {
      throw new Error(`Error de autenticaci√≥n: ${error.message}`);
    }
  }

  async loadAllData() {
    console.log('\nüìä Cargando datos del sistema...');
    
    try {
      await Promise.all([
        this.loadDashboard(),
        this.loadAllOrders(),
        this.loadProducts()
      ]);
      
      // Filtrar pedidos en proceso
      this.pendingOrders = this.allOrders.filter(o => 
        ['pending', 'confirmed', 'preparing', 'packed', 'shipped', 'ready_pickup'].includes(o.status)
      );
      
      console.log('   ‚úÖ Datos cargados exitosamente');
      console.log(`   üì¶ Total √≥rdenes: ${this.allOrders.length}`);
      console.log(`   ‚è≥ En proceso: ${this.pendingOrders.length}`);
      console.log(`   üì¶ Productos: ${this.products.length}`);
      
    } catch (error) {
      console.log(`   ‚ö†Ô∏è Error cargando datos: ${error.message}`);
    }
  }

  async loadDashboard() {
    try {
      const response = await axios.get(`${this.baseURL}/api/order-management/dashboard`, {
        headers: { 'Authorization': `Bearer ${this.adminToken}` }
      });
      if (response.data.success) {
        this.dashboard = response.data.data;
      }
    } catch (error) {
      console.warn('‚ö†Ô∏è Dashboard no disponible');
    }
  }

  async loadAllOrders() {
    try {
      const response = await axios.get(`${this.baseURL}/api/store/management/orders`, {
        headers: { 'Authorization': `Bearer ${this.adminToken}` },
        params: { limit: 100 }
      });
      if (response.data.success && response.data.data?.orders) {
        this.allOrders = response.data.data.orders;
      }
    } catch (error) {
      this.allOrders = [];
    }
  }

  async loadProducts() {
    try {
      const response = await axios.get(`${this.baseURL}/api/store/management/products`, {
        headers: { 'Authorization': `Bearer ${this.adminToken}` },
        params: { limit: 100 }
      });
      if (response.data.success && response.data.data?.products) {
        this.products = response.data.data.products;
      }
    } catch (error) {
      this.products = [];
    }
  }

  // ============================================================================
  // MEN√ö PRINCIPAL
  // ============================================================================

  async showMainMenu() {
    console.clear();
    console.log('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
    console.log('‚ïë                        üõí MEN√ö PRINCIPAL                                   ‚ïë');
    console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');
    
    // Mostrar resumen del dashboard
    if (this.dashboard?.summary) {
      const s = this.dashboard.summary;
      console.log('\nüìä RESUMEN DEL SISTEMA:');
      console.log(`   ‚è≥ Pendientes confirmaci√≥n: ${s.pendingConfirmation || 0}`);
      console.log(`   üè™ Listos para recogida: ${s.readyForPickup || 0}`);
      console.log(`   üì¶ Empaquetados para env√≠o: ${s.packedForShipping || 0}`);
      
      const pendingTransfers = s.pendingTransfers || 0;
      if (pendingTransfers > 0) {
        console.log(`   üè¶ TRANSFERENCIAS PENDIENTES: ${pendingTransfers} ‚ö†Ô∏è ¬°REQUIEREN VALIDACI√ìN!`);
      } else {
        console.log(`   ‚úÖ Transferencias pendientes: 0`);
      }
      
      console.log(`   üìÖ Pedidos hoy: ${s.ordersToday || 0}`);
      console.log(`   üí∞ Ingresos hoy: Q${(s.revenueToday || 0).toFixed(2)}`);
    }
    
    // Mostrar pedidos en proceso por tipo
    const byType = {
      delivery: this.pendingOrders.filter(o => o.deliveryType === 'delivery'),
      express: this.pendingOrders.filter(o => o.deliveryType === 'express'),
      pickup: this.pendingOrders.filter(o => o.deliveryType === 'pickup')
    };

    console.log('\nüì¶ PEDIDOS EN PROCESO POR TIPO:');
    console.log(`   üöö Env√≠os a domicilio: ${byType.delivery.length}`);
    console.log(`   ‚ö° Env√≠os express: ${byType.express.length}`);
    console.log(`   üè™ Para recoger en tienda: ${byType.pickup.length}`);
    
    console.log('\n' + '‚îÄ'.repeat(80));
    console.log('üìã OPCIONES DISPONIBLES:');
    console.log('‚îÄ'.repeat(80));
    console.log('1. üöö Gestionar ENV√çOS A DOMICILIO (delivery)');
    console.log('2. ‚ö° Gestionar ENV√çOS EXPRESS (prioridad alta)');
    console.log('3. üè™ Gestionar RECOGIDA EN TIENDA (pickup)');
    console.log('4. üè¶ Validar TRANSFERENCIAS pendientes ‚ö†Ô∏è ¬°PRIORITARIO!');
    console.log('5. üîç Buscar pedido espec√≠fico');
    console.log('6. üìä Ver dashboard completo');
    console.log('7. üîÑ Recargar datos del sistema');
    console.log('0. üö™ Salir del sistema');
    
    console.log('\nüí° RECORDATORIOS IMPORTANTES:');
    console.log('   üí≥ Tarjeta online: Pago procesado autom√°ticamente');
    console.log('   üè¶ Transferencias: DEBEN validarse antes de preparar');
    console.log('   üí∞ Efectivo: Se confirma al momento de entrega/recogida');
    
    const choice = await this.askQuestion('\nüõí Selecciona una opci√≥n (0-7): ');
    
    switch (choice.trim()) {
      case '1':
        await this.manageOrdersByType('delivery');
        break;
      case '2':
        await this.manageOrdersByType('express');
        break;
      case '3':
        await this.manageOrdersByType('pickup');
        break;
      case '4':
        await this.managePendingTransfers();
        break;
      case '5':
        await this.searchSpecificOrder();
        break;
      case '6':
        await this.showFullDashboard();
        break;
      case '7':
        await this.loadAllData();
        console.log('\n‚úÖ Datos actualizados');
        await this.askQuestion('\n‚èé Presiona Enter para continuar...');
        break;
      case '0':
        console.log('\nüëã ¬°Hasta luego! Cerrando sistema...');
        return;
      default:
        console.log('\n‚ùå Opci√≥n inv√°lida. Intenta de nuevo.');
        await this.askQuestion('\n‚èé Presiona Enter para continuar...');
    }
    
    await this.showMainMenu();
  }

  // ============================================================================
  // GESTI√ìN POR TIPO DE ENTREGA
  // ============================================================================

  async manageOrdersByType(deliveryType) {
    const workflow = this.workflows[deliveryType];
    const orders = this.pendingOrders.filter(o => o.deliveryType === deliveryType);

    console.clear();
    console.log('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
    console.log(`‚ïë  ${workflow.icon} GESTI√ìN DE: ${workflow.name.toUpperCase().padEnd(61)}‚ïë`);
    console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');

    if (orders.length === 0) {
      console.log(`\n‚úÖ No hay pedidos de tipo "${workflow.name}" en proceso`);
      await this.askQuestion('\n‚èé Presiona Enter para volver...');
      return;
    }

    // Mostrar flujo de trabajo
    console.log('\nüìã FLUJO DE TRABAJO:');
    console.log('‚îÄ'.repeat(80));
    workflow.steps.forEach((step, i) => {
      const arrow = i < workflow.steps.length - 1 ? ' ‚Üí ' : '';
      let extras = '';
      if (step.requiresTransferValidation) extras = ' [üè¶ Validar transferencia]';
      if (step.requiresTracking) extras = ' [üì¶ N√∫mero de gu√≠a]';
      if (step.requiresCashPayment) extras = ' [üí∞ Confirmar pago efectivo]';
      console.log(`   ${i + 1}. ${step.name}${extras}${arrow}`);
    });

    // Agrupar por estado
    console.log('\nüìä DISTRIBUCI√ìN POR ESTADO:');
    console.log('‚îÄ'.repeat(80));
    const byStatus = {};
    orders.forEach(order => {
      byStatus[order.status] = (byStatus[order.status] || []);
      byStatus[order.status].push(order);
    });

    workflow.steps.forEach(step => {
      const count = byStatus[step.status]?.length || 0;
      if (count > 0) {
        console.log(`   ${this.getStatusIcon(step.status)} ${step.name}: ${count} pedido(s)`);
      }
    });

    // Listar pedidos detallados
    console.log(`\nüì¶ LISTA DE PEDIDOS (${orders.length}):`);
    console.log('‚îÄ'.repeat(80));
    orders.forEach((order, i) => {
      const currentStep = workflow.steps.find(s => s.status === order.status);
      console.log(`\n   ${i + 1}. üì¶ Pedido #${order.orderNumber}`);
      console.log(`      üìä Estado: ${this.getStatusIcon(order.status)} ${currentStep?.name || order.status}`);
      console.log(`      üí∞ Total: Q${order.totalAmount}`);
      console.log(`      üë§ Cliente: ${this.getCustomerName(order)}`);
      console.log(`      üí≥ Pago: ${this.getPaymentMethodName(order.paymentMethod)}`);
      console.log(`      üìÖ Creado: ${new Date(order.createdAt).toLocaleString('es-GT')}`);
      
      // Alertas importantes
      if (order.paymentMethod.includes('transfer') && !order.transferConfirmed) {
        console.log(`      ‚ö†Ô∏è  TRANSFERENCIA PENDIENTE - Bloquea preparaci√≥n`);
      } else if (order.paymentMethod.includes('transfer') && order.transferConfirmed) {
        console.log(`      ‚úÖ Transferencia validada - Puede procesarse`);
      } else if (order.paymentMethod === 'online_card') {
        console.log(`      ‚úÖ Pago con tarjeta procesado autom√°ticamente`);
      }
      
      if (order.trackingNumber) {
        console.log(`      üì¶ Tracking: ${order.trackingNumber}`);
      }
    });

    console.log('\n' + '‚îÄ'.repeat(80));
    console.log('üìã ACCIONES DISPONIBLES:');
    console.log('‚îÄ'.repeat(80));
    console.log('1. ‚ñ∂Ô∏è  Avanzar pedido al siguiente paso');
    console.log('2. üëÅÔ∏è  Ver detalles completos de un pedido');
    console.log('3. üìã Ver flujo de trabajo de un pedido');
    console.log('4. ‚ùå Cancelar un pedido');
    console.log('0. ‚¨ÖÔ∏è  Volver al men√∫ principal');

    const action = await this.askQuestion(`\n${workflow.icon} Selecciona acci√≥n (0-4): `);

    switch (action.trim()) {
      case '1':
        await this.advanceOrderToNextStep(orders, workflow);
        break;
      case '2':
        await this.viewOrderDetails(orders);
        break;
      case '3':
        await this.showOrderWorkflow(orders, workflow);
        break;
      case '4':
        await this.cancelOrder(orders);
        break;
      case '0':
        return;
      default:
        console.log('\n‚ùå Opci√≥n inv√°lida');
        await this.askQuestion('\n‚èé Presiona Enter...');
    }

    // Volver a mostrar la gesti√≥n del mismo tipo
    await this.manageOrdersByType(deliveryType);
  }

  // ============================================================================
  // AVANZAR PEDIDO AL SIGUIENTE PASO
  // ============================================================================

  async advanceOrderToNextStep(orders, workflow) {
    console.clear();
    console.log('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
    console.log('‚ïë                    ‚ñ∂Ô∏è  AVANZAR PEDIDO AL SIGUIENTE PASO                    ‚ïë');
    console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');

    // Mostrar lista numerada
    console.log('\nüì¶ PEDIDOS DISPONIBLES:');
    orders.forEach((order, i) => {
      const currentStep = workflow.steps.find(s => s.status === order.status);
      console.log(`   ${i + 1}. #${order.orderNumber} - ${currentStep?.name} - Q${order.totalAmount}`);
    });

    const orderNum = await this.askQuestion('\nüì¶ N√∫mero de pedido (0 para cancelar): ');
    if (orderNum === '0') return;

    const orderIndex = parseInt(orderNum) - 1;
    if (orderIndex < 0 || orderIndex >= orders.length) {
      console.log('‚ùå N√∫mero inv√°lido');
      await this.askQuestion('\n‚èé Presiona Enter...');
      return;
    }

    const order = orders[orderIndex];
    const currentStep = workflow.steps.find(s => s.status === order.status);
    
    if (!currentStep) {
      console.log('‚ùå Estado del pedido no reconocido en el flujo de trabajo');
      await this.askQuestion('\n‚èé Presiona Enter...');
      return;
    }

    if (!currentStep.next) {
      console.log('‚úÖ Este pedido ya est√° en el estado final del flujo');
      await this.askQuestion('\n‚èé Presiona Enter...');
      return;
    }

    const nextStep = workflow.steps.find(s => s.status === currentStep.next);

    console.log('\n' + '‚îÄ'.repeat(80));
    console.log('üîÑ INFORMACI√ìN DEL CAMBIO:');
    console.log('‚îÄ'.repeat(80));
    console.log(`üì¶ Pedido: #${order.orderNumber}`);
    console.log(`üë§ Cliente: ${this.getCustomerName(order)}`);
    console.log(`üí∞ Total: Q${order.totalAmount}`);
    console.log(`üìä Estado actual: ${this.getStatusIcon(currentStep.status)} ${currentStep.name}`);
    console.log(`‚û°Ô∏è  Siguiente paso: ${this.getStatusIcon(nextStep.status)} ${nextStep.name}`);

    // üî• VALIDACI√ìN OBLIGATORIA DE TRANSFERENCIAS
    if (nextStep.requiresTransferValidation) {
      if (order.paymentMethod.includes('transfer') && !order.transferConfirmed) {
        console.log('\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
        console.log('‚ïë                    ‚ùå ERROR: TRANSFERENCIA NO VALIDADA                     ‚ïë');
        console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');
        console.log('\n‚ö†Ô∏è  No se puede iniciar la preparaci√≥n de este pedido');
        console.log('üè¶ Este pedido tiene una TRANSFERENCIA BANCARIA SIN VALIDAR');
        console.log('\nüìã ACCI√ìN REQUERIDA:');
        console.log('   1. Vuelve al men√∫ principal');
        console.log('   2. Selecciona la opci√≥n 4: "Validar TRANSFERENCIAS pendientes"');
        console.log('   3. Valida la transferencia de este pedido');
        console.log('   4. Luego podr√°s continuar con la preparaci√≥n');
        await this.askQuestion('\n‚èé Presiona Enter para volver...');
        return;
      }
    }

    // Manejar requerimientos especiales del paso
    let additionalData = {};

    // üì¶ TRACKING PARA ENV√çOS
    if (nextStep.requiresTracking) {
      console.log('\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
      console.log('‚ïë                     üì¶ GENERAR GU√çA DE ENV√çO                               ‚ïë');
      console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');
      
      const trackingNumber = await this.askQuestion('\nüì¶ N√∫mero de gu√≠a/tracking: ');
      const courier = await this.askQuestion('üöö Empresa de env√≠o (ej: DHL, FedEx, UPS): ');
      
      if (!trackingNumber.trim()) {
        console.log('\n‚ùå El n√∫mero de tracking es OBLIGATORIO para env√≠os');
        await this.askQuestion('\n‚èé Presiona Enter...');
        return;
      }
      
      additionalData.trackingNumber = trackingNumber.trim();
      additionalData.notes = `Enviado con ${courier}`;
      
      console.log(`\n‚úÖ Tracking registrado: ${trackingNumber}`);
    }

    // üí∞ CONFIRMACI√ìN DE PAGO (solo para efectivo/tarjeta contra entrega)
    if (nextStep.requiresCashPayment) {
      if (order.paymentMethod === 'cash_on_delivery') {
        console.log('\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
        console.log('‚ïë              üí∞ CONFIRMAR PAGO EN EFECTIVO CONTRA ENTREGA                  ‚ïë');
        console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');
        console.log(`\n   M√©todo: Efectivo contra entrega`);
        console.log(`   Monto a cobrar: Q${order.totalAmount}`);
        
        const paymentConfirmed = await this.askQuestion('\n¬øEl cliente pag√≥ en efectivo? (s/n): ');
        if (paymentConfirmed.toLowerCase() !== 's') {
          console.log('\n‚ùå No se puede completar la entrega sin confirmar el pago');
          await this.askQuestion('\n‚èé Presiona Enter...');
          return;
        }
        
        const receiptNumber = await this.askQuestion('N√∫mero de recibo (opcional): ');
        additionalData.notes = (additionalData.notes || '') + 
          `\nüí∞ Pago confirmado: Efectivo Q${order.totalAmount}` +
          (receiptNumber ? ` - Recibo: ${receiptNumber}` : '');
        
        console.log('\n‚úÖ Pago en efectivo confirmado');
      } 
      else if (order.paymentMethod === 'cash_on_pickup') {
        console.log('\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
        console.log('‚ïë               üí∞ CONFIRMAR PAGO EN EFECTIVO EN TIENDA                      ‚ïë');
        console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');
        console.log(`\n   M√©todo: Efectivo en tienda`);
        console.log(`   Monto a cobrar: Q${order.totalAmount}`);
        
        const verifyIdentity = await this.askQuestion('\n¬øVerificaste la identidad del cliente? (s/n): ');
        if (verifyIdentity.toLowerCase() !== 's') {
          console.log('\n‚ùå Por seguridad, verifica la identidad antes de entregar');
          await this.askQuestion('\n‚èé Presiona Enter...');
          return;
        }
        
        const paymentConfirmed = await this.askQuestion('¬øEl cliente pag√≥ en efectivo? (s/n): ');
        if (paymentConfirmed.toLowerCase() !== 's') {
          console.log('\n‚ùå No se puede completar sin confirmar el pago');
          await this.askQuestion('\n‚èé Presiona Enter...');
          return;
        }
        
        additionalData.notes = (additionalData.notes || '') + 
          `\nüí∞ Pago confirmado: Efectivo en tienda Q${order.totalAmount}\nüë§ Identidad verificada`;
        
        console.log('\n‚úÖ Pago confirmado e identidad verificada');
      }
      else if (order.paymentMethod === 'card_on_delivery') {
        console.log('\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
        console.log('‚ïë              üí≥ CONFIRMAR PAGO CON TARJETA CONTRA ENTREGA                  ‚ïë');
        console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');
        console.log(`\n   M√©todo: Tarjeta contra entrega`);
        console.log(`   Monto a cobrar: Q${order.totalAmount}`);
        
        const paymentConfirmed = await this.askQuestion('\n¬øSe proces√≥ el pago con tarjeta exitosamente? (s/n): ');
        if (paymentConfirmed.toLowerCase() !== 's') {
          console.log('\n‚ùå No se puede completar sin confirmar el pago');
          await this.askQuestion('\n‚èé Presiona Enter...');
          return;
        }
        
        const authCode = await this.askQuestion('C√≥digo de autorizaci√≥n (opcional): ');
        additionalData.notes = (additionalData.notes || '') + 
          `\nüí≥ Pago con tarjeta confirmado: Q${order.totalAmount}` +
          (authCode ? ` - Auth: ${authCode}` : '');
        
        console.log('\n‚úÖ Pago con tarjeta procesado');
      }
      else if (order.paymentMethod === 'online_card' || order.paymentMethod === 'transfer') {
        console.log('\n‚úÖ PAGO YA PROCESADO PREVIAMENTE');
        if (order.paymentMethod === 'online_card') {
          console.log('   üí≥ Pago con tarjeta online - Procesado autom√°ticamente');
        } else {
          console.log('   üè¶ Transferencia bancaria - Validada previamente');
        }
        additionalData.notes = (additionalData.notes || '') + 
          `\n‚úÖ Pago verificado: ${this.getPaymentMethodName(order.paymentMethod)}`;
      }
    }

    // Solicitar notas adicionales
    const notes = await this.askQuestion('\nüìù Notas adicionales (opcional, Enter para omitir): ');
    if (notes.trim()) {
      additionalData.notes = (additionalData.notes || '') + '\n' + notes.trim();
    }

    // Confirmaci√≥n final
    console.log('\n' + '‚îÄ'.repeat(80));
    const confirm = await this.askQuestion(`‚úÖ ¬øConfirmar avance a "${nextStep.name}"? (s/n): `);
    if (confirm.toLowerCase() !== 's') {
      console.log('\n‚ùå Operaci√≥n cancelada');
      await this.askQuestion('\n‚èé Presiona Enter...');
      return;
    }

    // Ejecutar actualizaci√≥n
    try {
      const response = await axios.patch(
        `${this.baseURL}/api/order-management/${order.id}/status`,
        {
          status: nextStep.status,
          ...additionalData
        },
        { headers: { 'Authorization': `Bearer ${this.adminToken}` } }
      );

      if (response.data.success) {
        console.log('\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
        console.log('‚ïë                         ‚úÖ OPERACI√ìN EXITOSA                               ‚ïë');
        console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');
        console.log(`\nüì¶ Pedido #${order.orderNumber} avanzado a: ${nextStep.name}`);
        
        if (nextStep.status === 'delivered' || nextStep.status === 'picked_up') {
          console.log('\nüìä ACCIONES AUTOM√ÅTICAS REALIZADAS:');
          console.log('   ‚úÖ Movimiento financiero registrado');
          console.log('   ‚úÖ Stock actualizado autom√°ticamente');
          console.log('   ‚úÖ Pedido completado');
        }
        
        await this.loadAllData();
      }
    } catch (error) {
      console.log('\n‚ùå ERROR al actualizar el pedido:');
      console.error('   ', error.response?.data?.message || error.message);
    }

    await this.askQuestion('\n‚èé Presiona Enter para continuar...');
  }

  // ============================================================================
  // MOSTRAR WORKFLOW DE UN PEDIDO
  // ============================================================================

  async showOrderWorkflow(orders, workflow) {
    console.clear();
    console.log('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
    console.log('‚ïë                    üìã FLUJO DE TRABAJO DEL PEDIDO                          ‚ïë');
    console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');

    // Mostrar lista
    console.log('\nüì¶ PEDIDOS DISPONIBLES:');
    orders.forEach((order, i) => {
      console.log(`   ${i + 1}. #${order.orderNumber} - ${this.getCustomerName(order)}`);
    });

    const orderNum = await this.askQuestion('\nüì¶ N√∫mero de pedido (0 para cancelar): ');
    if (orderNum === '0') return;

    const orderIndex = parseInt(orderNum) - 1;
    if (orderIndex < 0 || orderIndex >= orders.length) {
      console.log('‚ùå N√∫mero inv√°lido');
      await this.askQuestion('\n‚èé Presiona Enter...');
      return;
    }

    const order = orders[orderIndex];
    const currentStepIndex = workflow.steps.findIndex(s => s.status === order.status);

    console.log('\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
    console.log(`‚ïë  üì¶ PEDIDO #${order.orderNumber.padEnd(66)}‚ïë`);
    console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');

    console.log('\nüìã PROGRESO DEL FLUJO:');
    console.log('‚îÄ'.repeat(80));

    workflow.steps.forEach((step, i) => {
      const icon = i < currentStepIndex ? '‚úÖ' : 
                   i === currentStepIndex ? 'üîÑ' : '‚è≥';
      const status = i < currentStepIndex ? 'COMPLETADO' : 
                     i === currentStepIndex ? 'üî∏ ACTUAL üî∏' : 'PENDIENTE';
      
      console.log(`\n   ${icon} ${step.name} - ${status}`);
      console.log(`      ${step.description}`);
      
      if (step.requiresTransferValidation && i === currentStepIndex) {
        console.log(`      üè¶ Requiere: Validaci√≥n de transferencia (si aplica)`);
      }
      if (step.requiresTracking && i === currentStepIndex) {
        console.log(`      üì¶ Requiere: N√∫mero de gu√≠a/tracking obligatorio`);
      }
      if (step.requiresCashPayment && i === currentStepIndex) {
        if (order.paymentMethod === 'cash_on_delivery' || order.paymentMethod === 'cash_on_pickup') {
          console.log(`      üí∞ Requiere: Confirmaci√≥n de pago en efectivo`);
        } else if (order.paymentMethod === 'card_on_delivery') {
          console.log(`      üí≥ Requiere: Procesar pago con tarjeta`);
        } else {
          console.log(`      ‚úÖ Pago ya procesado`);
        }
      }
      
      if (i === currentStepIndex && step.next) {
        const nextStep = workflow.steps.find(s => s.status === step.next);
        console.log(`      ‚û°Ô∏è  Siguiente paso: ${nextStep.name}`);
      }
    });

    console.log('\n' + '‚îÄ'.repeat(80));
    console.log('üìä INFORMACI√ìN DEL PEDIDO:');
    console.log('‚îÄ'.repeat(80));
    console.log(`   üí∞ Total: Q${order.totalAmount}`);
    console.log(`   üë§ Cliente: ${this.getCustomerName(order)}`);
    console.log(`   üí≥ M√©todo de pago: ${this.getPaymentMethodName(order.paymentMethod)}`);
    console.log(`   üìÖ Fecha de creaci√≥n: ${new Date(order.createdAt).toLocaleString('es-GT')}`);

    if (order.trackingNumber) {
      console.log(`   üì¶ N√∫mero de tracking: ${order.trackingNumber}`);
    }

    // Estado detallado del pago
    console.log('\nüí≥ ESTADO DEL PAGO:');
    if (order.paymentMethod.includes('transfer')) {
      if (order.transferConfirmed) {
        console.log(`   ‚úÖ Transferencia VALIDADA - El pedido puede procesarse`);
      } else {
        console.log(`   ‚ö†Ô∏è  Transferencia PENDIENTE - Bloquea la preparaci√≥n del pedido`);
      }
    } else if (order.paymentMethod === 'online_card') {
      console.log(`   ‚úÖ Pago procesado autom√°ticamente con tarjeta online`);
    } else if (order.paymentMethod === 'cash_on_delivery' || order.paymentMethod === 'cash_on_pickup') {
      if (order.status === 'delivered' || order.status === 'picked_up') {
        console.log(`   ‚úÖ Pago confirmado al momento de la entrega`);
      } else {
        console.log(`   ‚è≥ Se confirmar√° al momento de la entrega/recogida`);
      }
    } else if (order.paymentMethod === 'card_on_delivery') {
      if (order.status === 'delivered') {
        console.log(`   ‚úÖ Pago procesado al momento de la entrega`);
      } else {
        console.log(`   ‚è≥ Se procesar√° al momento de la entrega`);
      }
    }

    await this.askQuestion('\n‚èé Presiona Enter para volver...');
  }

  // ============================================================================
  // GESTI√ìN DE TRANSFERENCIAS PENDIENTES
  // ============================================================================

  async managePendingTransfers() {
    console.clear();
    console.log('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
    console.log('‚ïë              üè¶ VALIDACI√ìN DE TRANSFERENCIAS BANCARIAS                     ‚ïë');
    console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');

    try {
      const response = await axios.get(`${this.baseURL}/api/order-management/pending-transfers`, {
        headers: { 'Authorization': `Bearer ${this.adminToken}` }
      });

      if (!response.data.success || !response.data.data?.orders || response.data.data.orders.length === 0) {
        console.log('\n‚úÖ ¬°Excelente! No hay transferencias pendientes de validar');
        console.log('\nTodas las transferencias han sido procesadas correctamente.');
        await this.askQuestion('\n‚èé Presiona Enter para volver...');
        return;
      }

      const transfers = response.data.data.orders;

      console.log(`\n‚ö†Ô∏è  HAY ${transfers.length} TRANSFERENCIA(S) PENDIENTE(S) DE VALIDACI√ìN`);
      console.log('‚îÄ'.repeat(80));
      console.log('\nEstas transferencias BLOQUEAN la preparaci√≥n de los pedidos.');
      console.log('Es PRIORITARIO validarlas para que los pedidos puedan procesarse.\n');

      transfers.forEach((order, i) => {
        const hoursWaiting = (new Date() - new Date(order.createdAt)) / 3600000;
        const priority = hoursWaiting > 24 ? 'üî¥ URGENTE' : hoursWaiting > 12 ? 'üü° ALTA' : 'üü¢ NORMAL';
        
        console.log(`\n   ${i + 1}. Pedido #${order.orderNumber}`);
        console.log(`      üí∞ Monto: Q${order.totalAmount}`);
        console.log(`      üë§ Cliente: ${this.getCustomerName(order)}`);
        console.log(`      üìÖ Fecha del pedido: ${new Date(order.createdAt).toLocaleString('es-GT')}`);
        console.log(`      ‚è±Ô∏è  Tiempo esperando: ${Math.floor(hoursWaiting)} horas`);
        console.log(`      üìä Estado del pedido: ${order.status}`);
        console.log(`      üö¶ Prioridad: ${priority}`);
      });

      console.log('\n' + '‚îÄ'.repeat(80));
      console.log('üìã ACCIONES DISPONIBLES:');
      console.log('‚îÄ'.repeat(80));
      console.log('1. ‚úÖ Validar una transferencia (aprobar)');
      console.log('2. ‚ùå Rechazar una transferencia');
      console.log('3. üëÅÔ∏è  Ver detalles de un pedido');
      console.log('0. ‚¨ÖÔ∏è  Volver al men√∫ principal');

      const action = await this.askQuestion('\nüè¶ Selecciona acci√≥n (0-3): ');

      switch (action.trim()) {
        case '1':
          await this.validateTransfer(transfers);
          break;
        case '2':
          await this.rejectTransfer(transfers);
          break;
        case '3':
          await this.viewTransferDetails(transfers);
          break;
        case '0':
          return;
        default:
          console.log('\n‚ùå Opci√≥n inv√°lida');
          await this.askQuestion('\n‚èé Presiona Enter...');
      }

      // Recargar y volver a mostrar
      await this.loadAllData();
      await this.managePendingTransfers();

    } catch (error) {
      console.error('\n‚ùå Error al cargar transferencias:', error.message);
      await this.askQuestion('\n‚èé Presiona Enter...');
    }
  }

  async validateTransfer(transfers) {
    console.log('\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
    console.log('‚ïë                    ‚úÖ VALIDAR TRANSFERENCIA BANCARIA                        ‚ïë');
    console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');

    const orderNum = await this.askQuestion('\nüì¶ N√∫mero de transferencia a validar (0 para cancelar): ');
    if (orderNum === '0') return;

    const orderIndex = parseInt(orderNum) - 1;
    if (orderIndex < 0 || orderIndex >= transfers.length) {
      console.log('\n‚ùå N√∫mero inv√°lido');
      await this.askQuestion('\n‚èé Presiona Enter...');
      return;
    }

    const order = transfers[orderIndex];
    
    console.log('\nüìä INFORMACI√ìN DEL PEDIDO:');
    console.log('‚îÄ'.repeat(80));
    console.log(`   Pedido: #${order.orderNumber}`);
    console.log(`   Cliente: ${this.getCustomerName(order)}`);
    console.log(`   Monto: Q${order.totalAmount}`);
    console.log(`   Tipo: ${order.deliveryType}`);

    console.log('\nüìù INFORMACI√ìN DE LA TRANSFERENCIA:');
    console.log('‚îÄ'.repeat(80));
    const voucherDetails = await this.askQuestion('Descripci√≥n del voucher/boleta: ');
    const bankReference = await this.askQuestion('N√∫mero de referencia bancaria: ');
    const notes = await this.askQuestion('Notas adicionales (opcional): ');

    if (!voucherDetails.trim() || !bankReference.trim()) {
      console.log('\n‚ùå La descripci√≥n del voucher y la referencia bancaria son obligatorias');
      await this.askQuestion('\n‚èé Presiona Enter...');
      return;
    }

    console.log('\n' + '‚îÄ'.repeat(80));
    const confirm = await this.askQuestion('‚úÖ ¬øCONFIRMAR que la transferencia es V√ÅLIDA? (s/n): ');
    if (confirm.toLowerCase() !== 's') {
      console.log('\n‚ùå Validaci√≥n cancelada');
      await this.askQuestion('\n‚èé Presiona Enter...');
      return;
    }

    try {
      const response = await axios.post(
        `${this.baseURL}/api/order-management/${order.id}/confirm-transfer`,
        {
          voucherDetails: voucherDetails.trim(),
          bankReference: bankReference.trim(),
          notes: notes.trim()
        },
        { headers: { 'Authorization': `Bearer ${this.adminToken}` } }
      );

      if (response.data.success) {
        console.log('\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
        console.log('‚ïë                    ‚úÖ TRANSFERENCIA VALIDADA EXITOSAMENTE                  ‚ïë');
        console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');
        console.log('\nüìä ACCIONES REALIZADAS:');
        console.log('   ‚úÖ Transferencia marcada como v√°lida');
        console.log('   ‚úÖ Movimiento financiero registrado');
        console.log('   ‚úÖ Pedido desbloqueado para preparaci√≥n');
        console.log('\nüí° El pedido ahora puede continuar su procesamiento normal.');
      }
    } catch (error) {
      console.log('\n‚ùå ERROR al validar transferencia:');
      console.error('   ', error.response?.data?.message || error.message);
    }

    await this.askQuestion('\n‚èé Presiona Enter para continuar...');
  }

  async rejectTransfer(transfers) {
    console.log('\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
    console.log('‚ïë                    ‚ùå RECHAZAR TRANSFERENCIA BANCARIA                       ‚ïë');
    console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');

    const orderNum = await this.askQuestion('\nüì¶ N√∫mero de transferencia a rechazar (0 para cancelar): ');
    if (orderNum === '0') return;

    const orderIndex = parseInt(orderNum) - 1;
    if (orderIndex < 0 || orderIndex >= transfers.length) {
      console.log('\n‚ùå N√∫mero inv√°lido');
      await this.askQuestion('\n‚èé Presiona Enter...');
      return;
    }

    const order = transfers[orderIndex];
    
    console.log('\nüìä INFORMACI√ìN DEL PEDIDO:');
    console.log(`   Pedido: #${order.orderNumber}`);
    console.log(`   Cliente: ${this.getCustomerName(order)}`);
    console.log(`   Monto: Q${order.totalAmount}`);

    const reason = await this.askQuestion('\nüìù Motivo del rechazo (obligatorio): ');
    
    if (!reason.trim()) {
      console.log('\n‚ùå Debes especificar un motivo para el rechazo');
      await this.askQuestion('\n‚èé Presiona Enter...');
      return;
    }

    console.log('\n‚ö†Ô∏è  ADVERTENCIA: Al rechazar la transferencia, el pedido ser√° CANCELADO');
    console.log('   - El stock ser√° restaurado');
    console.log('   - Se notificar√° al cliente');
    
    const confirm = await this.askQuestion('\n‚ùå ¬øCONFIRMAR RECHAZO de la transferencia? (s/n): ');
    if (confirm.toLowerCase() !== 's') {
      console.log('\n‚ùå Operaci√≥n cancelada');
      await this.askQuestion('\n‚èé Presiona Enter...');
      return;
    }

    try {
      const response = await axios.patch(
        `${this.baseURL}/api/order-management/${order.id}/status`,
        {
          status: 'cancelled',
          notes: `‚ùå PEDIDO CANCELADO - Transferencia rechazada\nMotivo: ${reason}`
        },
        { headers: { 'Authorization': `Bearer ${this.adminToken}` } }
      );

      if (response.data.success) {
        console.log('\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
        console.log('‚ïë                   ‚ùå TRANSFERENCIA RECHAZADA Y PEDIDO CANCELADO            ‚ïë');
        console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');
        console.log('\nüìä ACCIONES REALIZADAS:');
        console.log('   ‚ùå Transferencia rechazada');
        console.log('   ‚ùå Pedido cancelado');
        console.log('   ‚úÖ Stock restaurado autom√°ticamente');
        console.log('   üìß Se notificar√° al cliente del rechazo');
      }
    } catch (error) {
      console.log('\n‚ùå ERROR al rechazar transferencia:');
      console.error('   ', error.response?.data?.message || error.message);
    }

    await this.askQuestion('\n‚èé Presiona Enter para continuar...');
  }

  async viewTransferDetails(transfers) {
    const orderNum = await this.askQuestion('\nüì¶ N√∫mero de pedido: ');
    const idx = parseInt(orderNum) - 1;
    if (idx >= 0 && idx < transfers.length) {
      await this.showDetailedOrder(transfers[idx]);
      await this.askQuestion('\n‚èé Presiona Enter...');
    }
  }

  // ============================================================================
  // FUNCIONES AUXILIARES
  // ============================================================================

  async searchSpecificOrder() {
    console.clear();
    console.log('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
    console.log('‚ïë                          üîç BUSCAR PEDIDO                                  ‚ïë');
    console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');
    
    const searchTerm = await this.askQuestion('\nüîç N√∫mero de pedido o nombre de cliente: ');
    if (!searchTerm.trim()) return;

    const results = this.allOrders.filter(order => {
      const orderNum = (order.orderNumber || '').toLowerCase();
      const customerName = this.getCustomerName(order).toLowerCase();
      const search = searchTerm.toLowerCase();
      return orderNum.includes(search) || customerName.includes(search);
    });

    if (results.length === 0) {
      console.log('\n‚ùå No se encontraron pedidos con ese criterio');
    } else {
      console.log(`\n‚úÖ Se encontraron ${results.length} resultado(s):`);
      console.log('‚îÄ'.repeat(80));
      results.forEach((order, i) => {
        console.log(`   ${i + 1}. #${order.orderNumber} - ${order.status} - Q${order.totalAmount} - ${this.getCustomerName(order)}`);
      });
      
      const viewNum = await this.askQuestion('\nüëÅÔ∏è  Ver detalles de (n√∫mero, 0 para salir): ');
      if (viewNum !== '0') {
        const idx = parseInt(viewNum) - 1;
        if (idx >= 0 && idx < results.length) {
          await this.showDetailedOrder(results[idx]);
        }
      }
    }

    await this.askQuestion('\n‚èé Presiona Enter...');
  }

  async showDetailedOrder(order) {
    const workflow = this.workflows[order.deliveryType];
    
    console.log('\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
    console.log(`‚ïë  üì¶ DETALLES COMPLETOS - PEDIDO #${order.orderNumber.padEnd(48)}‚ïë`);
    console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');
    
    console.log('\nüìä INFORMACI√ìN GENERAL:');
    console.log(`   Estado: ${this.getStatusIcon(order.status)} ${order.status.toUpperCase()}`);
    console.log(`   Tipo: ${workflow?.icon || 'üì¶'} ${workflow?.name || order.deliveryType}`);
    console.log(`   Fecha: ${new Date(order.createdAt).toLocaleString('es-GT')}`);
    
    console.log('\nüë§ CLIENTE:');
    console.log(`   Nombre: ${this.getCustomerName(order)}`);
    if (order.user?.email) console.log(`   Email: ${order.user.email}`);
    if (order.user?.phone) console.log(`   Tel√©fono: ${order.user.phone}`);

    console.log('\nüí∞ RESUMEN FINANCIERO:');
    console.log(`   Subtotal: Q${order.subtotal || 0}`);
    console.log(`   Impuestos: Q${order.taxAmount || 0}`);
    console.log(`   Env√≠o: Q${order.shippingAmount || 0}`);
    if (order.discountAmount > 0) console.log(`   Descuento: -Q${order.discountAmount}`);
    console.log(`   TOTAL: Q${order.totalAmount}`);

    console.log('\nüí≥ INFORMACI√ìN DE PAGO:');
    console.log(`   M√©todo: ${this.getPaymentMethodName(order.paymentMethod)}`);
    
    if (order.paymentMethod.includes('transfer')) {
      if (order.transferConfirmed) {
        console.log(`   Estado: ‚úÖ Transferencia VALIDADA`);
      } else {
        console.log(`   Estado: ‚ö†Ô∏è  Transferencia PENDIENTE (bloquea preparaci√≥n)`);
      }
    } else if (order.paymentMethod === 'online_card') {
      console.log(`   Estado: ‚úÖ Procesado autom√°ticamente`);
    } else {
      console.log(`   Estado: ‚è≥ Se confirmar√° al entregar`);
    }

    if (order.trackingNumber) {
      console.log(`\nüì¶ Tracking: ${order.trackingNumber}`);
    }

    if (order.items?.length > 0) {
      console.log(`\nüì¶ PRODUCTOS (${order.items.length}):`);
      order.items.forEach(item => {
        console.log(`   ‚Ä¢ ${item.productName} x${item.quantity} = Q${item.totalPrice}`);
      });
    }
  }

  async showFullDashboard() {
    console.clear();
    console.log('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
    console.log('‚ïë                       üìä DASHBOARD COMPLETO                                ‚ïë');
    console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');

    if (this.dashboard?.summary) {
      const s = this.dashboard.summary;
      console.log('\nüìà ESTAD√çSTICAS GENERALES:');
      console.log('‚îÄ'.repeat(80));
      console.log(`   ‚è≥ Pendientes confirmaci√≥n: ${s.pendingConfirmation || 0}`);
      console.log(`   üè™ Listos para recogida: ${s.readyForPickup || 0}`);
      console.log(`   üì¶ Empaquetados: ${s.packedForShipping || 0}`);
      console.log(`   üè¶ Transferencias pendientes: ${s.pendingTransfers || 0}`);
      console.log(`   üìÖ Pedidos hoy: ${s.ordersToday || 0}`);
      console.log(`   üí∞ Ingresos hoy: Q${(s.revenueToday || 0).toFixed(2)}`);
      console.log(`   üìâ Stock bajo: ${s.lowStockCount || 0}`);
    }

    console.log('\nüìä DISTRIBUCI√ìN POR TIPO:');
    console.log('‚îÄ'.repeat(80));
    const byType = {
      pickup: this.allOrders.filter(o => o.deliveryType === 'pickup').length,
      delivery: this.allOrders.filter(o => o.deliveryType === 'delivery').length,
      express: this.allOrders.filter(o => o.deliveryType === 'express').length
    };
    console.log(`   üè™ Recogida: ${byType.pickup}`);
    console.log(`   üöö Domicilio: ${byType.delivery}`);
    console.log(`   ‚ö° Express: ${byType.express}`);

    console.log('\nüìä DISTRIBUCI√ìN POR ESTADO:');
    console.log('‚îÄ'.repeat(80));
    const byStatus = {};
    this.allOrders.forEach(order => {
      byStatus[order.status] = (byStatus[order.status] || 0) + 1;
    });
    Object.keys(byStatus).sort().forEach(status => {
      console.log(`   ${this.getStatusIcon(status)} ${status}: ${byStatus[status]}`);
    });

    await this.askQuestion('\n‚èé Presiona Enter para volver...');
  }

  async cancelOrder(orders) {
    console.log('\n‚ùå CANCELAR PEDIDO');
    const orderNum = await this.askQuestion('üì¶ N√∫mero a cancelar (0 para volver): ');
    if (orderNum === '0') return;

    const idx = parseInt(orderNum) - 1;
    if (idx < 0 || idx >= orders.length) {
      console.log('‚ùå N√∫mero inv√°lido');
      await this.askQuestion('\n‚èé Presiona Enter...');
      return;
    }

    const order = orders[idx];
    console.log(`\nüì¶ Pedido: #${order.orderNumber}`);
    console.log(`üí∞ Total: Q${order.totalAmount}`);
    
    const reason = await this.askQuestion('üìù Motivo de cancelaci√≥n: ');
    if (!reason.trim()) {
      console.log('‚ùå Debes especificar un motivo');
      await this.askQuestion('\n‚èé Presiona Enter...');
      return;
    }

    const confirm = await this.askQuestion('‚ùå ¬øCONFIRMAR CANCELACI√ìN? (s/n): ');
    if (confirm.toLowerCase() === 's') {
      try {
        await axios.patch(
          `${this.baseURL}/api/order-management/${order.id}/status`,
          { status: 'cancelled', notes: `CANCELADO: ${reason}` },
          { headers: { 'Authorization': `Bearer ${this.adminToken}` } }
        );
        console.log('\n‚úÖ Pedido cancelado. Stock restaurado.');
        await this.loadAllData();
      } catch (error) {
        console.error('‚ùå Error:', error.message);
      }
    }

    await this.askQuestion('\n‚èé Presiona Enter...');
  }

  async viewOrderDetails(orders) {
    const orderNum = await this.askQuestion('\nüì¶ N√∫mero de pedido: ');
    const idx = parseInt(orderNum) - 1;
    if (idx >= 0 && idx < orders.length) {
      await this.showDetailedOrder(orders[idx]);
      await this.askQuestion('\n‚èé Presiona Enter...');
    }
  }

  // Utilidades
  getStatusIcon(status) {
    const icons = {
      pending: '‚è≥', confirmed: '‚úÖ', preparing: 'üë®‚Äçüç≥',
      ready_pickup: 'üì¶', packed: 'üì¶', shipped: 'üöö',
      delivered: '‚úÖ', picked_up: '‚úÖ', cancelled: '‚ùå', refunded: 'üí∏'
    };
    return icons[status] || '‚ùì';
  }

  getPaymentMethodName(method) {
    const names = {
      'cash_on_delivery': 'Efectivo contra entrega',
      'cash_on_pickup': 'Efectivo en tienda',
      'card_on_delivery': 'Tarjeta contra entrega',
      'online_card': 'Tarjeta online (procesado)',
      'transfer': 'Transferencia bancaria',
      'transfer_on_delivery': 'Transferencia'
    };
    return names[method] || method;
  }

  getCustomerName(order) {
    if (order.user?.firstName || order.user?.lastName) {
      return `${order.user.firstName || ''} ${order.user.lastName || ''}`.trim();
    }
    if (order.customerInfo?.name) return order.customerInfo.name;
    if (order.customer?.name) return order.customer.name;
    return 'Cliente';
  }

  askQuestion(q) {
    return new Promise(resolve => this.rl.question(q, resolve));
  }
}

// ============================================================================
// EJECUCI√ìN
// ============================================================================

async function main() {
  const manager = new OnlineOrdersManager();
  await manager.start();
}

if (require.main === module) {
  main().catch(error => {
    console.error('\nüö® ERROR CR√çTICO:', error.message);
    process.exit(1);
  });
}

module.exports = { OnlineOrdersManager };