// test-membership-purchase.js - DOCTOR DEL SISTEMA v2: Usando rutas reales del backend - REPARADO
const axios = require('axios');

class SystemDoctorV2 {
  constructor(baseURL = 'http://localhost:5000') {
    this.baseURL = baseURL;
    this.tokens = {};
    this.diagnosis = {
      server: { status: 'unknown', details: [], issues: [], critical: true },
      database: { status: 'unknown', details: [], issues: [], critical: true },
      tables: { status: 'unknown', details: [], issues: [], critical: true },
      routes: { status: 'unknown', details: [], issues: [], critical: true },
      auth: { status: 'unknown', details: [], issues: [], critical: true },
      membership: { status: 'unknown', details: [], issues: [], critical: false },
      payments: { status: 'unknown', details: [], issues: [], critical: false }
    };
    this.recommendations = [];
    this.realRoutes = this.getRealRoutes();
  }

 getRealRoutes() {
    return {
      // Rutas b√°sicas y cr√≠ticas
      critical: [
        { method: 'GET', url: '/api/health', description: 'Salud del sistema', auth: false },
        { method: 'POST', url: '/api/auth/login', description: 'Login usuarios', auth: false },
        { method: 'GET', url: '/api/gym/config', description: 'Config gimnasio', auth: false },
        { method: 'GET', url: '/api/users', description: 'Lista usuarios', auth: true }
      ],
      
      // ‚úÖ CORREGIDO: Rutas REALES de membres√≠as (seg√∫n gymRoutes.js)
      membership: [
        { method: 'GET', url: '/api/gym/membership-plans', description: 'Planes p√∫blicos', auth: false },
        { method: 'GET', url: '/api/gym/services', description: 'Servicios gym', auth: false },
        { method: 'GET', url: '/api/gym/testimonials', description: 'Testimonios', auth: false },
        { method: 'GET', url: '/api/gym/stats', description: 'Estad√≠sticas gym', auth: false },
        { method: 'GET', url: '/api/gym/hours/flexible', description: 'Horarios flexibles', auth: false },
        { method: 'GET', url: '/api/gym/availability?day=monday', description: 'Disponibilidad gym', auth: false } // ‚úÖ CORREGIDO: Agregar par√°metro day requerido
      ],
      
      // ‚úÖ CORREGIDO: Rutas REALES de pagos (seg√∫n paymentRoutes.js)
      payments: [
        { method: 'GET', url: '/api/payments', description: 'Mis pagos', auth: true },
        { method: 'POST', url: '/api/payments', description: 'Crear pago', auth: true, requireStaff: true },
        { method: 'POST', url: '/api/payments/daily-income', description: 'Ingreso diario', auth: true, requireStaff: true },
        { method: 'POST', url: '/api/payments/activate-cash-membership', description: 'Activar efectivo', auth: true, requireStaff: true },
        { method: 'GET', url: '/api/payments/reports/enhanced', description: 'Reportes mejorados', auth: true, requireStaff: true }
      ]
    };
  }

  async runDiagnosis() {
    console.log('üè• ELITE FITNESS CLUB - DOCTOR DEL SISTEMA v2.0');
    console.log('‚ïê'.repeat(80));
    console.log('Diagnosticando con las rutas REALES de tu backend...\n');
    
    try {
      await this.diagnosticar1_ConexionServidor();
      await this.diagnosticar2_BaseDatos();
      await this.diagnosticar3_TablasEspecificas();
      await this.diagnosticar4_RutasCriticas();
      await this.diagnosticar5_SistemaAutenticacion();
      await this.diagnosticar6_SistemaMembresias();
      await this.diagnosticar7_SistemaPagos();
      
      this.generarDiagnosticoCompleto();
      
    } catch (error) {
      console.error('\nüíÄ ERROR CR√çTICO:', error.message);
      process.exit(1);
    }
  }

  async diagnosticar1_ConexionServidor() {
    console.log('üè• DIAGN√ìSTICO 1: CONEXI√ìN AL SERVIDOR');
    console.log('‚îÄ'.repeat(50));
    
    try {
      const startTime = Date.now();
      const response = await axios.get(`${this.baseURL}/api/health`, { timeout: 10000 });
      const responseTime = Date.now() - startTime;
      
      if (response.status === 200 && response.data?.success) {
        this.diagnosis.server.status = 'healthy';
        this.diagnosis.server.details.push(`‚úÖ Servidor responde en ${responseTime}ms`);
        this.diagnosis.server.details.push(`‚úÖ API funcional en puerto 5000`);
        
        // Analizar respuesta detallada
        const data = response.data;
        if (data.version) {
          this.diagnosis.server.details.push(`‚úÖ Versi√≥n: ${data.version}`);
        }
        
        if (data.database) {
          this.diagnosis.server.details.push(`‚úÖ BD status: ${data.database.status || 'connected'}`);
          if (data.database.dialect) {
            this.diagnosis.server.details.push(`‚úÖ BD tipo: ${data.database.dialect}`);
          }
        } else {
          this.diagnosis.server.issues.push('‚ö†Ô∏è Sin info de BD en /api/health');
          this.recommendations.push('Agregar info de BD al endpoint /api/health');
        }
        
        if (data.services) {
          const services = Object.keys(data.services);
          this.diagnosis.server.details.push(`‚úÖ Servicios: ${services.join(', ')}`);
        }
        
        if (data.payments) {
          const paymentMethods = Object.keys(data.payments);
          this.diagnosis.server.details.push(`‚úÖ M√©todos pago: ${paymentMethods.join(', ')}`);
        }
        
      } else {
        this.diagnosis.server.status = 'error';
        this.diagnosis.server.issues.push('‚ùå API responde pero success=false');
      }
      
    } catch (error) {
      this.diagnosis.server.status = 'error';
      
      if (error.code === 'ECONNREFUSED') {
        this.diagnosis.server.issues.push('‚ùå SERVIDOR NO EST√Å CORRIENDO');
        this.diagnosis.server.issues.push('   üî• SOLUCI√ìN: Ejecutar "npm start"');
        this.diagnosis.server.issues.push('   üî• Verificar que el puerto 5000 est√© libre');
        this.recommendations.push('CR√çTICO: npm start (el servidor no est√° corriendo)');
      } else if (error.code === 'ECONNABORTED') {
        this.diagnosis.server.issues.push('‚ùå SERVIDOR MUY LENTO O COLGADO');
        this.diagnosis.server.issues.push('   üî• SOLUCI√ìN: Reiniciar servidor o revisar logs');
        this.recommendations.push('CR√çTICO: Reiniciar servidor - performance cr√≠tica');
      } else {
        this.diagnosis.server.issues.push(`‚ùå Error: ${error.message}`);
      }
    }
    
    this.mostrarResultadoDiagnostico('SERVIDOR', this.diagnosis.server);
  }

  async diagnosticar2_BaseDatos() {
    console.log('\nüóÑÔ∏è DIAGN√ìSTICO 2: BASE DE DATOS');
    console.log('‚îÄ'.repeat(50));
    
    try {
      // Test 1: Consulta b√°sica de configuraci√≥n
      console.log('   üîç Test 1: Conexi√≥n b√°sica via /api/gym/config...');
      try {
        const configResponse = await axios.get(`${this.baseURL}/api/gym/config`);
        if (configResponse.data?.success) {
          this.diagnosis.database.details.push('‚úÖ BD responde - consulta b√°sica OK');
          this.diagnosis.database.details.push(`‚úÖ Gym: "${configResponse.data.data.gymName || configResponse.data.data.name}"`); // ‚úÖ CORREGIDO: Manejar ambos nombres de campo
        } else {
          this.diagnosis.database.issues.push('‚ùå BD responde pero sin datos v√°lidos');
        }
      } catch (dbError) {
        if (dbError.response?.status === 500) {
          this.diagnosis.database.issues.push('‚ùå ERROR SQL EN CONSULTA B√ÅSICA');
          this.diagnosis.database.issues.push(`   üìã Error: ${dbError.response.data?.message || dbError.message}`);
          
          // Interpretar errores espec√≠ficos de BD
          const errorMsg = dbError.response.data?.message || dbError.message || '';
          
          if (errorMsg.includes('ENOTFOUND') || errorMsg.includes('ECONNREFUSED')) {
            this.diagnosis.database.issues.push('   üî• PROBLEMA: Servidor de BD no est√° corriendo');
            this.recommendations.push('CR√çTICO: Iniciar MySQL/PostgreSQL');
          } else if (errorMsg.includes('Access denied') || errorMsg.includes('authentication failed')) {
            this.diagnosis.database.issues.push('   üî• PROBLEMA: Credenciales incorrectas');
            this.recommendations.push('CR√çTICO: Verificar DB_USER y DB_PASSWORD en .env');
          } else if (errorMsg.includes('database') && errorMsg.includes('does not exist')) {
            this.diagnosis.database.issues.push('   üî• PROBLEMA: Base de datos no existe');
            this.recommendations.push('CR√çTICO: Crear BD especificada en DB_NAME');
          } else if (errorMsg.includes('relation') && errorMsg.includes('does not exist')) {
            this.diagnosis.database.issues.push('   üî• PROBLEMA: Tablas no existen');
            this.recommendations.push('CR√çTICO: Ejecutar migraciones: npx sequelize-cli db:migrate');
          } else if (errorMsg.includes('column') && errorMsg.includes('does not exist')) {
            const columnMatch = errorMsg.match(/column "([^"]+)" does not exist/);
            if (columnMatch) {
              this.diagnosis.database.issues.push(`   üî• PROBLEMA: Columna "${columnMatch[1]}" no existe`);
              this.recommendations.push(`CR√çTICO: Migrar columna faltante: ${columnMatch[1]}`);
            }
          } else {
            this.diagnosis.database.issues.push(`   üî• Error SQL espec√≠fico: ${errorMsg.substring(0, 100)}...`);
          }
          
          this.diagnosis.database.status = 'error';
          return; // No continuar si hay error SQL cr√≠tico
        }
      }
      
      // Test 2: Verificar planes de membres√≠a
      console.log('   üîç Test 2: Tabla membership_plans...');
      try {
        const planesResponse = await axios.get(`${this.baseURL}/api/gym/membership-plans`); // ‚úÖ CORREGIDO: Usar ruta real
        if (planesResponse.data?.success && planesResponse.data.data?.plans) {
          const plans = planesResponse.data.data.plans;
          this.diagnosis.database.details.push(`‚úÖ Tabla membership_plans: ${plans.length} registros`);
          
          if (plans.length > 0) {
            const plan = plans[0];
            const campos = Object.keys(plan);
            this.diagnosis.database.details.push(`‚úÖ Campos plan: ${campos.slice(0, 6).join(', ')}...`);
            
            // Verificar campos cr√≠ticos
            const camposCriticos = ['id', 'planName', 'price', 'durationType'];
            const camposFaltantes = camposCriticos.filter(campo => !campos.includes(campo));
            
            if (camposFaltantes.length > 0) {
              this.diagnosis.database.issues.push(`‚ö†Ô∏è Campos faltantes en plans: ${camposFaltantes.join(', ')}`);
              this.recommendations.push(`Agregar campos a membership_plans: ${camposFaltantes.join(', ')}`);
            }
          } else {
            this.diagnosis.database.issues.push('‚ö†Ô∏è Tabla membership_plans est√° vac√≠a');
            this.recommendations.push('Ejecutar seeders para membership_plans');
          }
        }
      } catch (error) {
        this.diagnosis.database.issues.push('‚ùå Error accediendo tabla membership_plans');
      }
      
      // Test 3: Verificar usuarios (con auth si est√° disponible)
      if (this.tokens.admin) {
        console.log('   üîç Test 3: Tabla users...');
        try {
          const usersResponse = await axios.get(`${this.baseURL}/api/users?limit=1`, {
            headers: { Authorization: `Bearer ${this.tokens.admin}` }
          });
          
          if (usersResponse.data?.success && usersResponse.data.data?.users) {
            this.diagnosis.database.details.push('‚úÖ Tabla users: accesible');
          }
        } catch (error) {
          if (error.response?.status === 500) {
            this.diagnosis.database.issues.push('‚ùå Error SQL en tabla users');
          }
        }
      }
      
      if (this.diagnosis.database.status === 'unknown') {
        this.diagnosis.database.status = 'healthy';
        this.diagnosis.database.details.push('‚úÖ Base de datos funcionando correctamente');
      }
      
    } catch (error) {
      this.diagnosis.database.status = 'error';
      this.diagnosis.database.issues.push(`‚ùå Error diagnosticando BD: ${error.message}`);
    }
    
    this.mostrarResultadoDiagnostico('BASE DE DATOS', this.diagnosis.database);
  }

  async diagnosticar3_TablasEspecificas() {
    console.log('\nüìã DIAGN√ìSTICO 3: TABLAS ESPEC√çFICAS DEL SISTEMA');
    console.log('‚îÄ'.repeat(50));
    
    const tablasEsenciales = [
      {
        name: 'users',
        test: async () => {
          if (!this.tokens.admin) return { status: 'skip', reason: 'Sin token admin' };
          
          const response = await axios.get(`${this.baseURL}/api/users?limit=1`, {
            headers: { Authorization: `Bearer ${this.tokens.admin}` }
          });
          return { 
            status: 'ok', 
            data: response.data.data?.users?.[0],
            count: response.data.data?.users?.length || 0
          };
        },
        requiredFields: ['id', 'firstName', 'lastName', 'email', 'role'],
        description: 'Usuarios del sistema'
      },
      {
        name: 'gym_configuration', // ‚úÖ CORREGIDO: Nombre singular como en la tabla real
        test: async () => {
          const response = await axios.get(`${this.baseURL}/api/gym/config`);
          return { 
            status: 'ok', 
            data: response.data.data,
            count: response.data.data ? 1 : 0
          };
        },
        requiredFields: ['id', 'gymName', 'gymDescription'], // ‚úÖ CORREGIDO: Campos reales del modelo
        description: 'Configuraci√≥n del gimnasio'
      },
      {
        name: 'membership_plans',
        test: async () => {
          const response = await axios.get(`${this.baseURL}/api/gym/membership-plans`); // ‚úÖ CORREGIDO: Ruta real
          return { 
            status: 'ok', 
            data: response.data.data?.plans?.[0],
            count: response.data.data?.plans?.length || 0
          };
        },
        requiredFields: ['id', 'planName', 'price', 'durationType'],
        description: 'Planes de membres√≠a'
      },
      {
        name: 'memberships',
        test: async () => {
          if (!this.tokens.client) return { status: 'skip', reason: 'Sin token cliente' };
          
          const response = await axios.get(`${this.baseURL}/api/memberships`, {
            headers: { Authorization: `Bearer ${this.tokens.client}` }
          });
          return { 
            status: 'ok', 
            data: response.data.data?.[0] || null,
            count: response.data.data?.length || 0
          };
        },
        requiredFields: ['id', 'userId', 'planId', 'status'],
        description: 'Membres√≠as de usuarios'
      },
      {
        name: 'payments',
        test: async () => {
          if (!this.tokens.client) return { status: 'skip', reason: 'Sin token cliente' };
          
          const response = await axios.get(`${this.baseURL}/api/payments?limit=1`, {
            headers: { Authorization: `Bearer ${this.tokens.client}` }
          });
          return { 
            status: 'ok', 
            data: response.data.data?.[0] || null,
            count: response.data.data?.length || 0
          };
        },
        requiredFields: ['id', 'amount', 'paymentMethod', 'status'],
        description: 'Pagos del sistema'
      }
    ];

    let tablasOK = 0;
    let totalTablas = tablasEsenciales.length;

    for (const tabla of tablasEsenciales) {
      console.log(`   üîç Verificando tabla: ${tabla.name}`);
      
      try {
        const result = await tabla.test();
        
        if (result.status === 'skip') {
          this.diagnosis.tables.details.push(`‚è≠Ô∏è ${tabla.name}: ${result.reason}`);
          totalTablas--; // No contar las que no se pudieron probar
          continue;
        }
        
        if (result.status === 'ok') {
          tablasOK++;
          this.diagnosis.tables.details.push(`‚úÖ ${tabla.name}: EXISTE (${result.count} registros)`);
          
          // Verificar campos si hay datos
          if (result.data && typeof result.data === 'object') {
            const camposEncontrados = Object.keys(result.data);
            const camposFaltantes = tabla.requiredFields.filter(campo => !camposEncontrados.includes(campo));
            
            if (camposFaltantes.length === 0) {
              this.diagnosis.tables.details.push(`   üìä Campos: ${camposEncontrados.slice(0, 6).join(', ')}...`);
            } else {
              this.diagnosis.tables.issues.push(`   ‚ùå Campos faltantes en ${tabla.name}: ${camposFaltantes.join(', ')}`);
              this.recommendations.push(`CR√çTICO: Agregar campos a tabla ${tabla.name}: ${camposFaltantes.join(', ')}`);
              
              // Mostrar campos encontrados para debug
              this.diagnosis.tables.details.push(`   üìä Campos encontrados: ${camposEncontrados.slice(0, 6).join(', ')}...`);
            }
          } else if (result.count === 0) {
            this.diagnosis.tables.issues.push(`   ‚ö†Ô∏è Tabla ${tabla.name} est√° vac√≠a`);
            if (tabla.name === 'membership_plans' || tabla.name === 'users') {
              this.recommendations.push(`Ejecutar seeders para ${tabla.name}`);
            }
          }
        }
        
      } catch (error) {
        if (error.response?.status === 500) {
          this.diagnosis.tables.issues.push(`‚ùå ${tabla.name}: ERROR SQL - Tabla probablemente no existe`);
          
          const errorMsg = error.response.data?.message || error.message || '';
          if (errorMsg.includes('relation') && errorMsg.includes('does not exist')) {
            this.diagnosis.tables.issues.push(`   üî• TABLA "${tabla.name}" NO EXISTE EN LA BD`);
            this.recommendations.push(`CR√çTICO: Crear tabla ${tabla.name} - ejecutar migraci√≥n correspondiente`);
          } else if (errorMsg.includes('column') && errorMsg.includes('does not exist')) {
            this.diagnosis.tables.issues.push(`   üî• COLUMNA FALTANTE en tabla ${tabla.name}`);
            this.recommendations.push(`CR√çTICO: Ejecutar migraciones para actualizar ${tabla.name}`);
          }
        } else if (error.response?.status === 404) {
          this.diagnosis.tables.issues.push(`‚ùå ${tabla.name}: Endpoint no existe - ruta no implementada`);
        } else if (error.response?.status === 401) {
          this.diagnosis.tables.issues.push(`‚ö†Ô∏è ${tabla.name}: Sin permisos de acceso`);
        } else {
          this.diagnosis.tables.issues.push(`‚ùå ${tabla.name}: ${error.message}`);
        }
      }
    }

    // Evaluar status general
    if (tablasOK === totalTablas && totalTablas > 0) {
      this.diagnosis.tables.status = 'healthy';
      this.diagnosis.tables.details.push(`üéâ Todas las tablas esenciales (${totalTablas}) funcionan correctamente`);
    } else if (tablasOK > totalTablas / 2) {
      this.diagnosis.tables.status = 'warning';
      this.diagnosis.tables.details.push(`‚ö†Ô∏è ${tablasOK}/${totalTablas} tablas funcionan correctamente`);
    } else {
      this.diagnosis.tables.status = 'error';
      this.diagnosis.tables.issues.push(`‚ùå Solo ${tablasOK}/${totalTablas} tablas funcionan - sistema cr√≠tico`);
      this.recommendations.push('CR√çTICO: Ejecutar todas las migraciones: npx sequelize-cli db:migrate');
    }

    this.mostrarResultadoDiagnostico('TABLAS ESPEC√çFICAS', this.diagnosis.tables);
  }

  async diagnosticar4_RutasCriticas() {
    console.log('\nüõ§Ô∏è DIAGN√ìSTICO 4: RUTAS CR√çTICAS DEL SISTEMA');
    console.log('‚îÄ'.repeat(50));
    
    let rutasCriticasOK = 0;
    let totalCriticas = this.realRoutes.critical.length;
    
    console.log('   üîç Probando rutas cr√≠ticas del sistema...');
    
    for (const ruta of this.realRoutes.critical) {
      try {
        let response;
        const headers = ruta.auth && this.tokens.admin ? 
          { Authorization: `Bearer ${this.tokens.admin}` } : {};
        
        if (ruta.method === 'GET') {
          response = await axios.get(`${this.baseURL}${ruta.url}`, { 
            headers,
            timeout: 5000
          });
        } else if (ruta.method === 'POST') {
          const testData = this.generarDatosPrueba(ruta.url);
          response = await axios.post(`${this.baseURL}${ruta.url}`, testData, { 
            headers,
            timeout: 5000
          });
        }
        
        if (response?.data?.success) {
          rutasCriticasOK++;
          this.diagnosis.routes.details.push(`‚úÖ ${ruta.method} ${ruta.url}: FUNCIONA`);
        } else {
          this.diagnosis.routes.issues.push(`‚ùå ${ruta.method} ${ruta.url}: Responde pero success=false`);
        }
        
      } catch (error) {
        const errorDetail = this.interpretarErrorRuta(error, ruta.url);
        
        if (error.response?.status === 404) {
          this.diagnosis.routes.issues.push(`‚ùå ${ruta.method} ${ruta.url}: NO IMPLEMENTADA (404)`);
          this.recommendations.push(`CR√çTICO: Implementar ruta ${ruta.url}`);
        } else if (error.response?.status === 500) {
          this.diagnosis.routes.issues.push(`‚ùå ${ruta.method} ${ruta.url}: ERROR SERVIDOR (500)`);
          this.diagnosis.routes.issues.push(`   üî• Detalles: ${error.response.data?.message || 'Error interno'}`);
          this.recommendations.push(`CR√çTICO: Corregir error en ${ruta.url} - revisar logs`);
        } else if (error.response?.status === 401 && ruta.auth) {
          // Error de auth en ruta protegida puede ser normal si no hay token
          if (!this.tokens.admin) {
            this.diagnosis.routes.details.push(`‚ö†Ô∏è ${ruta.method} ${ruta.url}: Requiere auth (sin token para probar)`);
          } else {
            this.diagnosis.routes.issues.push(`‚ùå ${ruta.method} ${ruta.url}: Token inv√°lido`);
          }
        } else {
          this.diagnosis.routes.issues.push(`‚ùå ${ruta.method} ${ruta.url}: ${errorDetail}`);
        }
      }
    }
    
    console.log(`   üìä Rutas cr√≠ticas funcionando: ${rutasCriticasOK}/${totalCriticas}`);
    
    if (rutasCriticasOK === totalCriticas) {
      this.diagnosis.routes.status = 'healthy';
      this.diagnosis.routes.details.push('üéâ Todas las rutas cr√≠ticas funcionan correctamente');
    } else if (rutasCriticasOK > totalCriticas / 2) {
      this.diagnosis.routes.status = 'warning';
      this.diagnosis.routes.details.push(`‚ö†Ô∏è ${rutasCriticasOK}/${totalCriticas} rutas cr√≠ticas funcionan`);
    } else {
      this.diagnosis.routes.status = 'error';
      this.diagnosis.routes.issues.push(`‚ùå Solo ${rutasCriticasOK}/${totalCriticas} rutas cr√≠ticas funcionan`);
    }
    
    this.mostrarResultadoDiagnostico('RUTAS CR√çTICAS', this.diagnosis.routes);
  }

  async diagnosticar5_SistemaAutenticacion() {
    console.log('\nüîê DIAGN√ìSTICO 5: SISTEMA DE AUTENTICACI√ìN');
    console.log('‚îÄ'.repeat(50));
    
    try {
      // Test 1: Login admin por defecto
      console.log('   üîç Test 1: Login admin por defecto...');
      try {
        const loginResponse = await axios.post(`${this.baseURL}/api/auth/login`, {
          email: 'admin@gym.com',
          password: 'Admin123!'
        });
        
        if (loginResponse.data?.success && loginResponse.data.data?.token) {
          this.tokens.admin = loginResponse.data.data.token;
          this.diagnosis.auth.status = 'healthy';
          this.diagnosis.auth.details.push('‚úÖ Usuario admin por defecto EXISTE y funciona');
          this.diagnosis.auth.details.push(`‚úÖ Email: admin@gym.com`);
          this.diagnosis.auth.details.push(`‚úÖ Token generado correctamente`);
          this.diagnosis.auth.details.push(`‚úÖ Usuario: ${loginResponse.data.data.user.firstName} ${loginResponse.data.data.user.lastName}`);
          this.diagnosis.auth.details.push(`‚úÖ Rol: ${loginResponse.data.data.user.role}`);
          
          // Test 2: Validar token en ruta protegida
          console.log('   üîç Test 2: Validando token en ruta protegida...');
          try {
            const protectedResponse = await axios.get(`${this.baseURL}/api/users?limit=1`, {
              headers: { Authorization: `Bearer ${this.tokens.admin}` }
            });
            
            if (protectedResponse.data?.success) {
              this.diagnosis.auth.details.push('‚úÖ Token v√°lido para rutas protegidas');
            } else {
              this.diagnosis.auth.issues.push('‚ö†Ô∏è Token generado pero rutas protegidas fallan');
            }
          } catch (authError) {
            this.diagnosis.auth.issues.push(`‚ö†Ô∏è Error validando token: ${authError.response?.status} - ${authError.message}`);
          }
          
        } else {
          this.diagnosis.auth.issues.push('‚ùå Login responde pero sin token v√°lido');
        }
        
      } catch (loginError) {
        this.diagnosis.auth.status = 'error';
        
        if (loginError.response?.status === 401) {
          this.diagnosis.auth.issues.push('‚ùå USUARIO ADMIN POR DEFECTO NO EXISTE');
          this.diagnosis.auth.issues.push('   üî• PROBLEMA: No hay admin@gym.com en la tabla users');
          this.diagnosis.auth.issues.push('   üî• O la contrase√±a no es Admin123!');
          this.diagnosis.auth.issues.push('   üî• SOLUCI√ìN: Crear usuario admin manualmente');
          this.recommendations.push('CR√çTICO: Crear usuario admin@gym.com con password Admin123! y role=admin');
          this.recommendations.push('O ejecutar seeder: npx sequelize-cli db:seed:all');
        } else if (loginError.response?.status === 500) {
          this.diagnosis.auth.issues.push('‚ùå ERROR SERVIDOR EN LOGIN');
          this.diagnosis.auth.issues.push(`   üî• Error SQL: ${loginError.response.data?.message}`);
          this.diagnosis.auth.issues.push('   üî• PROBLEMA: Tabla users no existe o est√° mal configurada');
          this.recommendations.push('CR√çTICO: Verificar tabla users y ejecutar migraciones');
        } else {
          this.diagnosis.auth.issues.push(`‚ùå Error desconocido en login: ${loginError.message}`);
        }
      }
      
      // Test 3: Crear usuario de prueba (si admin funciona)
      if (this.tokens.admin) {
        console.log('   üîç Test 3: Creando usuario cliente de prueba...');
        
        const testEmail = `testclient.${Date.now()}@test.com`;
        try {
          const userResponse = await axios.post(`${this.baseURL}/api/users`, {
            firstName: 'Test',
            lastName: 'Client',
            email: testEmail,
            password: 'Test123!',
            role: 'cliente'
          }, {
            headers: { Authorization: `Bearer ${this.tokens.admin}` }
          });
          
          if (userResponse.data?.success) {
            this.diagnosis.auth.details.push('‚úÖ Creaci√≥n de usuarios funciona');
            
            // Test login del nuevo usuario
            try {
              const clientLoginResponse = await axios.post(`${this.baseURL}/api/auth/login`, {
                email: testEmail,
                password: 'Test123!'
              });
              
              if (clientLoginResponse.data?.success && clientLoginResponse.data.data?.token) {
                this.tokens.client = clientLoginResponse.data.data.token;
                this.diagnosis.auth.details.push('‚úÖ Login de usuarios creados funciona');
              }
            } catch (clientLoginError) {
              this.diagnosis.auth.issues.push('‚ö†Ô∏è Usuario se crea pero no puede hacer login');
            }
          }
          
        } catch (createError) {
          if (createError.response?.status === 400) {
            this.diagnosis.auth.details.push('‚ö†Ô∏è Creaci√≥n requiere validaciones espec√≠ficas (normal)');
          } else if (createError.response?.status === 404) {
            this.diagnosis.auth.issues.push('‚ùå Ruta POST /api/users no implementada');
            this.recommendations.push('Implementar creaci√≥n de usuarios via /api/users');
          } else {
            this.diagnosis.auth.issues.push(`‚ö†Ô∏è Error creando usuario: ${createError.message}`);
          }
        }
      }
      
    } catch (error) {
      this.diagnosis.auth.status = 'error';
      this.diagnosis.auth.issues.push(`‚ùå Error diagnosticando autenticaci√≥n: ${error.message}`);
    }
    
    this.mostrarResultadoDiagnostico('SISTEMA DE AUTENTICACI√ìN', this.diagnosis.auth);
  }

  async diagnosticar6_SistemaMembresias() {
    console.log('\nüé´ DIAGN√ìSTICO 6: SISTEMA DE MEMBRES√çAS');
    console.log('‚îÄ'.repeat(50));
    
    try {
      let funcionesOK = 0;
      const totalFunciones = this.realRoutes.membership.length;
      
      for (const ruta of this.realRoutes.membership) {
        console.log(`   üîç Probando: ${ruta.description}...`);
        
        try {
          // Determinar headers necesarios
          let headers = {};
          if (ruta.auth) {
            if (ruta.requireStaff && this.tokens.admin) {
              headers.Authorization = `Bearer ${this.tokens.admin}`;
            } else if (this.tokens.client) {
              headers.Authorization = `Bearer ${this.tokens.client}`;
            } else if (this.tokens.admin) {
              headers.Authorization = `Bearer ${this.tokens.admin}`;
            } else {
              this.diagnosis.membership.details.push(`‚è≠Ô∏è ${ruta.description}: Sin token para probar`);
              continue;
            }
          }
          
          let response;
          
          if (ruta.method === 'GET') {
            response = await axios.get(`${this.baseURL}${ruta.url}`, { headers });
          } else if (ruta.method === 'POST') {
            const testData = this.generarDatosPruebaMembership(ruta.url);
            response = await axios.post(`${this.baseURL}${ruta.url}`, testData, { headers });
          }
          
          if (response?.data?.success) {
            funcionesOK++;
            this.diagnosis.membership.details.push(`‚úÖ ${ruta.description}: FUNCIONA`);
            
            // Analizar datos espec√≠ficos
            if (ruta.url.includes('/plans') && response.data.data?.plans) {
              const plans = response.data.data.plans;
              this.diagnosis.membership.details.push(`   üìä ${plans.length} planes disponibles`);
            } else if (ruta.url.includes('/memberships') && response.data.data) {
              const memberships = Array.isArray(response.data.data) ? response.data.data : [response.data.data];
              this.diagnosis.membership.details.push(`   üìä ${memberships.length} membres√≠as encontradas`);
            }
            
          } else {
            this.diagnosis.membership.issues.push(`‚ùå ${ruta.description}: Responde pero success=false`);
          }
          
        } catch (error) {
          const errorDetail = this.interpretarErrorRuta(error, ruta.url);
          
          if (error.response?.status === 404) {
            this.diagnosis.membership.issues.push(`‚ùå ${ruta.description}: Ruta no implementada (404)`);
            this.recommendations.push(`Implementar ruta de membres√≠as: ${ruta.url}`);
          } else if (error.response?.status === 500) {
            this.diagnosis.membership.issues.push(`‚ùå ${ruta.description}: Error servidor (500)`);
            if (error.response.data?.message) {
              this.diagnosis.membership.issues.push(`   üî• ${error.response.data.message}`);
            }
          } else if (error.response?.status === 401) {
            this.diagnosis.membership.details.push(`‚ö†Ô∏è ${ruta.description}: Requiere autenticaci√≥n`);
          } else if (error.response?.status === 400) {
            this.diagnosis.membership.issues.push(`‚ùå ${ruta.description}: VALIDACI√ìN FALLIDA (400) - ${error.response.data?.message || 'Datos inv√°lidos'}`);
          } else {
            this.diagnosis.membership.issues.push(`‚ùå ${ruta.description}: ${errorDetail}`);
          }
        }
      }
      
      // Evaluar status del sistema de membres√≠as
      if (funcionesOK === totalFunciones) {
        this.diagnosis.membership.status = 'healthy';
        this.diagnosis.membership.details.push('üéâ Sistema de membres√≠as completamente funcional');
      } else if (funcionesOK > totalFunciones / 2) {
        this.diagnosis.membership.status = 'warning';
        this.diagnosis.membership.details.push(`‚ö†Ô∏è ${funcionesOK}/${totalFunciones} funciones de membres√≠as funcionan`);
      } else {
        this.diagnosis.membership.status = 'error';
        this.diagnosis.membership.issues.push(`‚ùå Solo ${funcionesOK}/${totalFunciones} funciones funcionan`);
      }
      
      console.log(`   üìä Funciones de membres√≠as: ${funcionesOK}/${totalFunciones}`);
      
    } catch (error) {
      this.diagnosis.membership.status = 'error';
      this.diagnosis.membership.issues.push(`‚ùå Error diagnosticando membres√≠as: ${error.message}`);
    }
    
    this.mostrarResultadoDiagnostico('SISTEMA DE MEMBRES√çAS', this.diagnosis.membership);
  }

  async diagnosticar7_SistemaPagos() {
    console.log('\nüí≥ DIAGN√ìSTICO 7: SISTEMA DE PAGOS');
    console.log('‚îÄ'.repeat(50));
    
    try {
      let funcionesOK = 0;
      const totalFunciones = this.realRoutes.payments.length;
      
      for (const ruta of this.realRoutes.payments) {
        console.log(`   üîç Probando: ${ruta.description}...`);
        
        try {
          // Determinar headers necesarios
          let headers = {};
          if (ruta.auth) {
            if (ruta.requireStaff && this.tokens.admin) {
              headers.Authorization = `Bearer ${this.tokens.admin}`;
            } else if (this.tokens.client) {
              headers.Authorization = `Bearer ${this.tokens.client}`;
            } else if (this.tokens.admin) {
              headers.Authorization = `Bearer ${this.tokens.admin}`;
            } else {
              this.diagnosis.payments.details.push(`‚è≠Ô∏è ${ruta.description}: Sin token para probar`);
              continue;
            }
          }
          
          let response;
          
          if (ruta.method === 'GET') {
            response = await axios.get(`${this.baseURL}${ruta.url}`, { headers });
          } else if (ruta.method === 'POST') {
            const testData = this.generarDatosPruebaPagos(ruta.url);
            response = await axios.post(`${this.baseURL}${ruta.url}`, testData, { headers });
          }
          
          if (response?.data?.success) {
            funcionesOK++;
            this.diagnosis.payments.details.push(`‚úÖ ${ruta.description}: FUNCIONA`);
            
            // Analizar datos espec√≠ficos
            if (ruta.url.includes('/reports') && response.data.data) {
              this.diagnosis.payments.details.push(`   üìä Reportes financieros disponibles`);
            } else if (ruta.url === '/api/payments' && response.data.data) {
              const payments = Array.isArray(response.data.data) ? response.data.data : [response.data.data];
              this.diagnosis.payments.details.push(`   üìä ${payments.length} pagos encontrados`);
            }
            
          } else {
            this.diagnosis.payments.issues.push(`‚ùå ${ruta.description}: Responde pero success=false`);
          }
          
        } catch (error) {
          const errorDetail = this.interpretarErrorRuta(error, ruta.url);
          
          if (error.response?.status === 404) {
            this.diagnosis.payments.issues.push(`‚ùå ${ruta.description}: Ruta no implementada (404)`);
            this.recommendations.push(`Implementar ruta de pagos: ${ruta.url}`);
          } else if (error.response?.status === 500) {
            this.diagnosis.payments.issues.push(`‚ùå ${ruta.description}: Error servidor (500)`);
            if (error.response.data?.message) {
              this.diagnosis.payments.issues.push(`   üî• ${error.response.data.message}`);
            }
          } else if (error.response?.status === 401) {
            this.diagnosis.payments.details.push(`‚ö†Ô∏è ${ruta.description}: Requiere autenticaci√≥n`);
          } else if (error.response?.status === 403) {
            this.diagnosis.payments.details.push(`‚ö†Ô∏è ${ruta.description}: Requiere permisos espec√≠ficos`);
          } else if (error.response?.status === 400) {
            this.diagnosis.payments.issues.push(`‚ùå ${ruta.description}: VALIDACI√ìN FALLIDA (400) - ${error.response.data?.message || 'Errores de validaci√≥n'}`);
          } else {
            this.diagnosis.payments.issues.push(`‚ùå ${ruta.description}: ${errorDetail}`);
          }
        }
      }
      
      // Evaluar status del sistema de pagos
      if (funcionesOK === totalFunciones) {
        this.diagnosis.payments.status = 'healthy';
        this.diagnosis.payments.details.push('üéâ Sistema de pagos completamente funcional');
      } else if (funcionesOK > totalFunciones / 2) {
        this.diagnosis.payments.status = 'warning';
        this.diagnosis.payments.details.push(`‚ö†Ô∏è ${funcionesOK}/${totalFunciones} funciones de pagos funcionan`);
      } else {
        this.diagnosis.payments.status = 'error';
        this.diagnosis.payments.issues.push(`‚ùå Solo ${funcionesOK}/${totalFunciones} funciones funcionan`);
      }
      
      console.log(`   üìä Funciones de pagos: ${funcionesOK}/${totalFunciones}`);
      
    } catch (error) {
      this.diagnosis.payments.status = 'error';
      this.diagnosis.payments.issues.push(`‚ùå Error diagnosticando pagos: ${error.message}`);
    }
    
    this.mostrarResultadoDiagnostico('SISTEMA DE PAGOS', this.diagnosis.payments);
  }

  // ‚úÖ CORREGIDO: Datos de prueba mejorados
  generarDatosPrueba(url) {
    if (url.includes('/auth/login')) {
      return { email: 'admin@gym.com', password: 'Admin123!' };
    } else if (url.includes('/auth/register')) {
      return { 
        firstName: 'Test', 
        lastName: 'User', 
        email: `test${Date.now()}@test.com`, 
        password: 'Test123!' 
      };
    } else if (url.includes('/users')) {
      return { 
        firstName: 'Test', 
        lastName: 'User', 
        email: `test${Date.now()}@test.com`, 
        password: 'Test123!',
        role: 'cliente'
      };
    }
    return {};
  }

  generarDatosPruebaMembership(url) {
    if (url.includes('/purchase')) {
      return {
        planId: 1,
        selectedSchedule: { monday: [1] },
        paymentMethod: 'cash',
        // ‚úÖ AGREGADO: Datos adicionales que podr√≠an requerirse
        userId: 'test-user-id',
        type: 'monthly'
      };
    }
    return {};
  }

  // ‚úÖ CORREGIDO: Datos de prueba para pagos mejorados
  generarDatosPruebaPagos(url) {
    if (url.includes('/daily-income')) {
      return {
        amount: 25.00,
        paymentMethod: 'cash',
        paymentType: 'daily', // ‚úÖ AGREGADO: Campo que requiere el modelo Payment
        description: 'Pago diario de prueba',
        // ‚úÖ AGREGADO: Para pagos an√≥nimos
        anonymousClientInfo: {
          name: 'Cliente Prueba',
          phone: '+502 1234-5678'
        }
      };
    } else if (url.includes('/activate-cash-membership')) {
      return {
        membershipId: 'test-id'
      };
    } else if (url === '/api/payments') {
      return {
        amount: 100.00,
        paymentMethod: 'cash',
        paymentType: 'membership', // ‚úÖ AGREGADO: Campo requerido
        // ‚úÖ AGREGADO: Informaci√≥n del cliente an√≥nimo
        anonymousClientInfo: {
          name: 'Cliente Test',
          phone: '+502 9999-9999',
          notes: 'Pago de prueba'
        }
      };
    }
    return {};
  }

  interpretarErrorRuta(error, url) {
    if (error.response) {
      const status = error.response.status;
      const data = error.response.data;
      
      switch (status) {
        case 404:
          return 'NO IMPLEMENTADA (404)';
        case 401:
          return 'SIN AUTORIZACI√ìN (401)';
        case 403:
          return 'PROHIBIDO (403)';
        case 400:
          return `VALIDACI√ìN FALLIDA (400) - ${data?.message || 'Datos inv√°lidos'}`;
        case 500:
          return `ERROR SERVIDOR (500) - ${data?.message || 'Error interno'}`;
        default:
          return `HTTP ${status} - ${data?.message || 'Error desconocido'}`;
      }
    } else if (error.code === 'ECONNABORTED') {
      return 'TIMEOUT';
    } else {
      return error.message;
    }
  }

  mostrarResultadoDiagnostico(categoria, diagnosis) {
    const statusIcon = {
      'healthy': 'üíö',
      'warning': '‚ö†Ô∏è',
      'error': '‚ù§Ô∏è',
      'unknown': '‚ùì'
    };
    
    console.log(`\n   ${statusIcon[diagnosis.status]} ${categoria}: ${diagnosis.status.toUpperCase()}`);
    
    if (diagnosis.details.length > 0) {
      diagnosis.details.forEach(detail => console.log(`      ${detail}`));
    }
    
    if (diagnosis.issues.length > 0) {
      diagnosis.issues.forEach(issue => console.log(`      ${issue}`));
    }
  }

  generarDiagnosticoCompleto() {
    console.log('\nüìã DIAGN√ìSTICO COMPLETO DEL SISTEMA');
    console.log('‚ïê'.repeat(80));
    
    const sistemas = [
      { name: 'Servidor', data: this.diagnosis.server, critical: true },
      { name: 'Base de Datos', data: this.diagnosis.database, critical: true },
      { name: 'Tablas', data: this.diagnosis.tables, critical: true },
      { name: 'Rutas', data: this.diagnosis.routes, critical: true },
      { name: 'Autenticaci√≥n', data: this.diagnosis.auth, critical: true },
      { name: 'Membres√≠as', data: this.diagnosis.membership, critical: false },
      { name: 'Pagos', data: this.diagnosis.payments, critical: false }
    ];
    
    let sistemasHealthy = 0;
    let sistemasWarning = 0;
    let sistemasCriticos = 0;
    let sistemasCriticosTotal = 0;
    
    sistemas.forEach(sistema => {
      const status = sistema.data.status;
      const icon = this.getStatusIcon(status);
      const criticalMark = sistema.critical ? ' üî•' : '';
      
      console.log(`${icon} ${sistema.name}${criticalMark}: ${status.toUpperCase()}`);
      
      if (sistema.critical) {
        sistemasCriticosTotal++;
        if (status === 'healthy') sistemasHealthy++;
        else if (status === 'error') sistemasCriticos++;
      } else {
        if (status === 'healthy') sistemasHealthy++;
        else if (status === 'warning') sistemasWarning++;
        else if (status === 'error') sistemasCriticos++;
      }
    });
    
    const totalSistemas = sistemas.length;
    const sistemasOK = sistemas.filter(s => s.data.status === 'healthy').length;
    const healthPercentage = ((sistemasOK / totalSistemas) * 100).toFixed(1);
    
    console.log('\nüìä RESUMEN EJECUTIVO:');
    console.log(`   üíö Sistemas funcionando: ${sistemasOK}/${totalSistemas} (${healthPercentage}%)`);
    console.log(`   ‚ö†Ô∏è Sistemas con advertencias: ${sistemasWarning}`);
    console.log(`   ‚ù§Ô∏è Sistemas con errores: ${sistemasCriticos}`);
    console.log(`   üî• Sistemas cr√≠ticos fallando: ${sistemas.filter(s => s.critical && s.data.status === 'error').length}/${sistemasCriticosTotal}`);
    
    // Diagn√≥stico espec√≠fico
    if (sistemasCriticos === 0 && sistemasOK >= totalSistemas * 0.8) {
      console.log('\nüéâ DIAGN√ìSTICO: SISTEMA COMPLETAMENTE SALUDABLE');
      console.log('   Tu backend est√° funcionando correctamente');
      console.log('   Todas las funcionalidades cr√≠ticas operativas');
    } else if (sistemas.filter(s => s.critical && s.data.status === 'error').length === 0) {
      console.log('\n‚úÖ DIAGN√ìSTICO: SISTEMA FUNCIONAL');
      console.log('   Los componentes cr√≠ticos funcionan correctamente');
      console.log('   Algunas funcionalidades avanzadas pueden necesitar mejoras');
    } else {
      console.log('\nüö® DIAGN√ìSTICO: PROBLEMAS CR√çTICOS DETECTADOS');
      console.log('   Hay componentes esenciales que requieren atenci√≥n inmediata');
    }
    
    console.log('\nüîß RECOMENDACIONES PRIORIZADAS POR CRITICIDAD:');
    console.log('‚ïê'.repeat(50));
    
    if (this.recommendations.length === 0) {
      console.log('‚úÖ No hay recomendaciones cr√≠ticas - Tu sistema est√° bien configurado');
    } else {
      // Separar recomendaciones cr√≠ticas de normales
      const criticasRecs = this.recommendations.filter(rec => rec.includes('CR√çTICO'));
      const normalesRecs = this.recommendations.filter(rec => !rec.includes('CR√çTICO'));
      
      if (criticasRecs.length > 0) {
        console.log('\nüö® CR√çTICAS (Resolver PRIMERO):');
        criticasRecs.forEach((rec, index) => {
          console.log(`   ${index + 1}. ${rec.replace('CR√çTICO: ', '')}`);
        });
      }
      
      if (normalesRecs.length > 0) {
        console.log('\nüí° MEJORAS (Resolver despu√©s):');
        normalesRecs.forEach((rec, index) => {
          console.log(`   ${index + 1}. ${rec}`);
        });
      }
    }
    
    console.log('\nüìã PLAN DE ACCI√ìN ESPEC√çFICO:');
    console.log('‚îÄ'.repeat(50));
    
    // Plan de acci√≥n basado en diagn√≥stico espec√≠fico
    if (this.diagnosis.server.status === 'error') {
      console.log('üö® PASO 1: INICIAR SERVIDOR');
      console.log('   ‚Üí npm start');
      console.log('   ‚Üí Verificar puerto 5000 libre');
    } else if (this.diagnosis.database.status === 'error') {
      console.log('üö® PASO 1: SOLUCIONAR BASE DE DATOS');
      if (this.diagnosis.database.issues.some(i => i.includes('no est√° corriendo'))) {
        console.log('   ‚Üí Iniciar MySQL/PostgreSQL');
        console.log('   ‚Üí sudo service mysql start  (Linux)');
        console.log('   ‚Üí brew services start mysql  (Mac)');
      } else if (this.diagnosis.database.issues.some(i => i.includes('Credenciales'))) {
        console.log('   ‚Üí Verificar DB_USER y DB_PASSWORD en .env');
        console.log('   ‚Üí Verificar que el usuario tenga permisos');
      } else if (this.diagnosis.database.issues.some(i => i.includes('no existe'))) {
        console.log('   ‚Üí Crear base de datos especificada en DB_NAME');
        console.log('   ‚Üí CREATE DATABASE nombrebd;');
      }
    } else if (this.diagnosis.tables.status === 'error') {
      console.log('üö® PASO 1: EJECUTAR MIGRACIONES');
      console.log('   ‚Üí npx sequelize-cli db:migrate');
      console.log('   ‚Üí npx sequelize-cli db:seed:all');
    } else if (this.diagnosis.auth.status === 'error') {
      console.log('üö® PASO 1: CREAR USUARIO ADMIN');
      console.log('   ‚Üí Insertar usuario admin manualmente en BD');
      console.log('   ‚Üí O ejecutar seeder correspondiente');
    } else {
      console.log('‚úÖ PASOS B√ÅSICOS COMPLETADOS');
      console.log('üí° PASO SIGUIENTE: Implementar funcionalidades del manual');
      console.log('   ‚Üí Revisar rutas faltantes del sistema de membres√≠as');
      console.log('   ‚Üí Implementar validaciones espec√≠ficas');
      console.log('   ‚Üí Configurar servicios opcionales');
    }
    
    console.log('\nüè• DIAGN√ìSTICO ESPEC√çFICO COMPLETADO');
    console.log('Ahora tienes un plan exacto de qu√© arreglar y en qu√© orden');
  }

  getStatusIcon(status) {
    const icons = {
      'healthy': 'üíö',
      'warning': '‚ö†Ô∏è',
      'error': '‚ù§Ô∏è',
      'unknown': '‚ùì'
    };
    return icons[status] || '‚ùì';
  }
}

// Funci√≥n para mostrar ayuda
function showHelp() {
  console.log('\nüè• Elite Fitness Club - Doctor del Sistema v2.0\n');
  console.log('Uso:');
  console.log('   node test-membership-purchase.js        # Diagn√≥stico con rutas reales');
  console.log('   node test-membership-purchase.js --help # Mostrar ayuda\n');
  
  console.log('ü©∫ Esta versi√≥n usa las rutas REALES de tu backend:');
  console.log('   üìã Basado en membershipRoutes.js y paymentRoutes.js');
  console.log('   üéØ Prueba rutas que S√ç tienes implementadas');
  console.log('   üîç Detecta exactamente qu√© tabla o columna falta');
  console.log('   üí° Da pasos espec√≠ficos para solucionar cada problema\n');
  
  console.log('üìä Diagn√≥stico por capas:');
  console.log('   üè• Servidor (¬øest√° corriendo?)');
  console.log('   üóÑÔ∏è Base de datos (¬øconecta? ¬øcredenciales OK?)');
  console.log('   üìã Tablas espec√≠ficas (¬øexisten? ¬øcampos correctos?)');
  console.log('   üõ§Ô∏è Rutas reales (seg√∫n tus archivos de rutas)');
  console.log('   üîê Autenticaci√≥n (¬øadmin existe? ¬øtokens OK?)');
  console.log('   üé´ Sistema membres√≠as (rutas espec√≠ficas)');
  console.log('   üí≥ Sistema pagos (rutas espec√≠ficas)\n');
  
  console.log('üéØ Resultado: Plan de acci√≥n exacto y priorizado');
}

// Ejecutar script
async function main() {
  const args = process.argv.slice(2);
  
  if (args.includes('--help') || args.includes('-h')) {
    showHelp();
    return;
  }
  
  const doctor = new SystemDoctorV2();
  
  try {
    await doctor.runDiagnosis();
    
  } catch (error) {
    console.error('\nüíÄ DIAGN√ìSTICO FALL√ì:');
    console.error(`Error: ${error.message}`);
    
    console.error('\nüö® VERIFICACIONES B√ÅSICAS:');
    console.error('1. ¬øServidor corriendo? ‚Üí npm start');
    console.error('2. ¬øPuerto 5000 libre? ‚Üí netstat -an | grep 5000');
    console.error('3. ¬øBD corriendo? ‚Üí sudo service mysql status');
    console.error('4. ¬øVariables .env OK? ‚Üí cat .env');
    
    process.exit(1);
  }
}

// Ejecutar si se llama directamente
if (require.main === module) {
  main();
}

module.exports = { SystemDoctorV2 };